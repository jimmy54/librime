# Gboard背后的机器智能

*2017年5月24日*

*作者：Françoise Beaufays，语音和键盘团队首席科学家，以及Michael Riley，语音和语言算法团队首席科学家*

大多数人每天都会花费大量时间使用移动设备键盘：撰写邮件、发送短信、参与社交媒体等等。然而，移动键盘的使用仍然很不便捷。平均而言，用户在移动设备上的打字速度比在物理键盘上慢约35%。为了改变这一状况，我们最近为Android版Gboard提供了许多令人兴奋的改进，朝着我们的愿景迈进：创建一种智能机制，在任何你选择的语言中实现更快速的输入，同时提供建议并纠正错误。

随着我们认识到移动键盘将触摸输入转换为文本的方式与语音识别系统将语音输入转换为文本的方式相似，我们利用我们在语音识别方面的经验来实现我们的愿景。首先，我们创建了强大的空间模型，将模糊的原始触摸点序列映射到键盘上的按键，就像声学模型将声音片段序列映射到语音单元一样。其次，我们基于有限状态转换器(FST)构建了强大的核心解码引擎，以确定给定输入触摸序列最可能的单词序列。凭借其数学形式和在语音应用中的广泛成功，我们知道FST解码器将提供支持各种复杂键盘输入行为和语言特性所需的灵活性。在这篇文章中，我们将详细介绍这两个系统的开发过程。

## 神经空间模型

移动键盘输入容易出现错误，这些错误通常归因于"肥手指打字"（或在滑行输入中追踪空间上相似的单词，如下图所示），以及认知和运动错误（表现为拼写错误、字符插入、删除或交换等）。一个智能键盘需要能够考虑这些错误，并快速准确地预测用户意图输入的单词。因此，我们为Gboard构建了一个空间模型，在字符级别解决这些错误，将屏幕上的触摸点映射到实际的按键。

![平均滑行轨迹对比两个空间相似的单词："Vampire"和"Value"](https://4.bp.blogspot.com/-7htLmt4v5Yw/WSW8UsoXeKI/AAAAAAAAB1U/PsaG7sKYAtwUVaiTbU_qz-6xNwXzN3aOQCLcB/s640/image2.gif)

直到最近，Gboard还使用高斯模型来量化点击邻近按键的概率，并使用基于规则的模型来表示认知和运动错误。这些模型简单直观，但它们不允许我们直接优化与更好的打字质量相关的指标。借鉴我们在Voice Search声学模型方面的经验，我们用单一的、高效的长短期记忆(LSTM)模型替换了高斯和基于规则的模型，该模型使用连接主义时序分类(CTC)准则进行训练。

然而，训练这个模型比我们预期的要复杂得多。虽然声学模型是从人工转录的音频数据中训练的，但人们不能轻易地转录数百万的触摸点序列和滑行轨迹。因此，团队利用用户交互信号，例如撤销的自动更正和建议选择作为负面和正面的半监督学习信号，形成丰富的训练和测试集。

![对应单词"could"的原始数据点（左），以及标准化的采样轨迹和每个样本的方差（右）](https://2.bp.blogspot.com/-Q8bVYEwuTnw/WSW9PRtDRSI/AAAAAAAAB1c/vY4UfiCFETAAplzo1-QHW76PwkQUXvkXgCLcB/s640/f2.png)

我们使用了语音识别文献中的大量技术来迭代NSM模型，使其足够小且足够快以在任何设备上运行。TensorFlow基础架构被用来训练数百个模型，优化键盘显示的各种信号：补全、建议、滑行等。经过一年多的工作，最终的模型比初始版本快约6倍，小约10倍，在离线数据集上显示出约15%的不良自动更正减少和10%的错误解码手势减少。

## 有限状态转换器

虽然NSM使用空间信息来帮助确定点击或滑动的内容，但还有其他约束条件——*词汇的*和*语法的*——可以应用。词典告诉我们一种语言中出现了哪些单词，而概率语法则告诉我们哪些单词可能跟在其他单词之后。为了编码这些信息，我们使用有限状态转换器。FST长期以来一直是Google语音识别和合成系统的关键组成部分。它们提供了一种有原则的方式来表示自然语言处理中使用的各种概率模型（词典、语法、标准化器等），同时提供了操作、优化、组合和搜索模型所需的数学框架。

在Gboard中，键到单词的转换器紧凑地表示键盘词典，如下图所示。它编码了从按键序列到单词的映射，允许替代按键序列和可选空格。

![这个转换器沿着从起始状态（粗体圆圈1）到终止状态（双圆圈状态0和1）的路径编码了"I"、"I've"、"If"](https://4.bp.blogspot.com/-J9yqtO7u-Nw/WSW9nXoRWiI/AAAAAAAAB1g/NLCjKa-0KSIVcQXtSTmuqdyO-xaNL0wHACLcB/s640/image7.png)

概率n-gram转换器用于表示键盘的语言模型。模型中的状态表示（最多）n-1个单词的上下文，离开该状态的弧标有后续单词及其在该上下文之后的概率（从文本数据中估计）。这些，与给出按键触摸序列（离散点击输入或滑行输入中的连续手势）可能性的空间模型一起，被组合并用束搜索进行探索。

通用FST原则，如流式处理、支持动态模型等，在构建新键盘解码器方面帮助了我们很多，但也必须添加几个新功能。当你说话时，你不需要解码器来完成你的单词或猜测你接下来会说什么来节省几个音节；但当你打字时，你会欣赏单词补全和预测的帮助。此外，我们希望键盘提供无缝的多语言支持，如下所示。

![Gboard中的三语输入打字](https://1.bp.blogspot.com/-Oz-oMYfar8I/WSW90Jo866I/AAAAAAAAB1k/GO-9rpbpTcMhsfy3edD3lgcjXlLlTQjlwCLcB/s640/image6.gif)

让我们的新解码器运行起来是一项复杂的工作，但FST的原则性质有很多好处。例如，支持像印地语这样的语言的音译只是通用解码器的简单扩展。

## 音译模型

在许多具有复杂文字的语言中，已经开发了罗马化系统，将字符映射到拉丁字母表中，通常根据它们的语音发音。例如，拼音"xièxiè"对应中文字符"谢谢"（"thank you"）。拼音键盘允许用户方便地在QWERTY布局上输入单词，并自动"翻译"成目标文字。同样，音译的印地语键盘允许用户输入"daanth"表示"दांत"（牙齿）。虽然拼音是一个约定俗成的罗马化系统，但印地语音译更加模糊；例如，"daant"也是"दांत"的有效替代。

![印地语音译滑行输入](https://2.bp.blogspot.com/-8CuSHDQtrd0/WSW9_xZDH3I/AAAAAAAAB1o/eDBYuZeA7okkwCBZ_8sZu0xBcQ8bbel_QCLcB/s640/image5.gif)

正如我们有从字母序列到单词的转换器（词典）和提供单词序列概率的加权语言模型自动机，我们为22种印度语言构建了拉丁键序列和目标文字符号序列之间的加权转换器映射。一些语言有多种书写系统（例如，Bodo可以用孟加拉语或梵文字母书写），所以在音译和原生布局之间，我们在短短几个月内构建了57种新的输入方法。

FST解码器的通用性使我们能够利用我们为支持补全、预测、滑行输入和许多UI功能所做的所有工作，无需额外努力，使我们能够从一开始就为印度用户提供丰富的体验。

## 更智能的键盘

总的来说，我们最近的工作将解码延迟降低了50%，减少了用户必须手动纠正的单词比例超过10%，允许我们为印度的22种官方语言推出音译支持，并启用了许多你可能已经注意到的新功能。

虽然我们希望这些最近的变化能改善你的打字体验，但我们意识到设备上的打字问题远未解决。Gboard仍然可能提出看似不直观或实用性低的建议，手势仍然可能被解码为人类永远不会选择的单词。然而，我们向强大的机器智能算法的转变已经开辟了新的空间，我们正在积极探索，为全球用户制作更有用的工具和产品。

## 致谢

这项工作由Cyril Allauzen、Ouais Alsharif、Lars Hellsten、Tom Ouyang、Brian Roark和David Rybach完成，得到了语音数据操作团队的帮助。特别感谢Johan Schalkwyk和Corinna Cortes的支持。


**\*** 相关算法的工具箱可在[OpenFst](http://www.openfst.org/)开源库中获得。

## 标签
* 产品
* 语音处理
