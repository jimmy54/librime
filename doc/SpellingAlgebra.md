# 拼寫運算詳解（SpellingAlgebra）

作者：佛振 chen.sst@gmail.com  
日期：2012-02-14

## 概述

**拼寫運算**（Spelling Algebra）是RIME输入法的独门绝技，通过按规则改写编码形式，实现多种定制功能的技术。

## 核心概念

### 基本术语

- **输入法**：以输入信号序列到输出文本序列的转换方法；RIME可搭载多种不同类型的输入法，称为"输入方案"
- **字符集**：构成目标输出文本的字符集合，主要由汉字组成
- **编码**：用于检索目标字符的字母序列
- **字母**：构成编码的字符，亦称"码元"
- **字母表**：字母的集合，亦称"编码字符集"，通常由小写拉丁字母组成
- **码表**：目标字符集与编码集合之间的映射表
- **码长**：单个编码所包含的字母个数
  - **定长编码**：码表中所有编码码长一致
  - **限长编码**：规定了最大码长的编码方案
- **编码空间**：给定字母表以有限码长排列组合所得的可用编码数目
- **音节表**：输入方案中所有编码的集合
  - 拼音输入方案：音节表是固定的可穷举集合
  - 形码输入法：按规则在编码空间内为新生词组编码，无法给出固定音节表
- **重码**：对应到多个输出字符的编码
- **输入码**：用作输入的字符序列
- **候选**：与输入码相关联的目标输出文字；当有重码时，候选文字形成列表供用户挑选
- **拼写**：与单个编码相对应的输入码；拼写可能不同于编码
- **拼写法**：一种输入方案里，有效拼写集合到编码集合的映射，亦称"正字法"
- **拼寫運算**：以拼写为运算元的一元运算，通过字符串匹配及替换操作对拼写实施文字变换，获得新的拼写，并可赋予结果附加属性
- **投影**：以拼写法为运算元的一元运算，获得衍生的拼写法；实际运用时，通常对拼写法连续执行一组投影操作

## 主要功能

拼寫運算可以实现以下功能：

### 1. 简拼（Abbreviation）
允许使用首字母或部分字母输入完整音节。

**示例**：
- `zhong` → `z`（首字母简拼）
- `zhang` → `zh`（声母简拼）

### 2. 模糊音（Fuzzy Spelling）
将发音相近的音节视为等效。

**常见模糊音**：
- `zh=z`, `ch=c`, `sh=s`（平翘舌不分）
- `n=l`（鼻边音不分）
- `en=eng`, `in=ing`（前后鼻音不分）
- `an=ang`, `ian=iang`

### 3. 容错拼写（Error Tolerance）
纠正常见的拼写错误。

**示例**：
- `guei` = `gui`
- `jiou` = `jiu`
- `dagn` = `dang`

### 4. 音节切分（Syllable Segmentation）
自动识别拼音边界，无需手动分隔。

### 5. 编码回显（Code Display）
在输入过程中显示特殊字符。

**示例**：
- 显示拼音字母 `ü`
- 显示倉頡字母符号

## 拼寫運算的运算子

### 1. 转写（xlit）

**功能**：字母表之间的一一映射转换

**格式**：`xlit|源字母表|目标字母表|`

**示例**：
```yaml
xlit|abcdefghijklmnopqrstuvwxyz|日月金木水火土竹戈十大中一弓人心手口尸廿山女田難卜符|
```
**效果**：将拉丁字母转换为倉頡字母（a→日, b→月, c→金...）

**注意**：转写是唯一使用UTF-32编码处理的运算，支持非ASCII字符。

### 2. 变形（xform）

**功能**：使用正则表达式进行字符串替换

**格式**：`xform/<模式>/<替换式>/`

**示例**：
```yaml
xform/([nl])v/$1ü/
```
**效果**：将 `nv` 转换为 `nü`，`lv` 转换为 `lü`

**更多示例**：
```yaml
xform/ui$/uei/          # gui → guei
xform/iu$/iou/          # jiu → jiou
xform/([aeiou])ng$/$1gn/  # dang → dagn
```

### 3. 消除（erase）

**功能**：删除匹配指定模式的拼写

**格式**：`erase/<模式>/`

**示例**：
```yaml
erase/^xx$/
```
**效果**：删除编码 `xx`

**应用场景**：
- 从音节表中排除特定编码
- 清理无效或冲突的拼写

### 4. 派生（derive）

**功能**：创建等效拼写，原拼写保持不变

**格式**：`derive/<模式>/<替换式>/`

**示例**：
```yaml
derive/^([zcs])h/$1/    # zh→z, ch→c, sh→s（保留原拼写）
derive/^n/l/            # n→l（保留n）
derive/([ei])n$/$1ng/   # en→eng, in→ing（保留原拼写）
```

**效果**：输入 `z` 可以匹配 `zh` 的候选，但 `zh` 仍然有效

**应用场景**：
- 实现模糊音
- 提供容错拼写
- 支持多种输入习惯

### 5. 模糊（fuzz）

**功能**：创建用于构词但不用于单字输入的简码

**格式**：`fuzz/<模式>/<替换式>/`

**示例**：
```yaml
fuzz/^([a-z]).+([a-z])$/$1$2/
```
**效果**：以首、尾码为多字母音节码的构词码

**配合使用**：
```yaml
translator:
  strict_spelling: true  # 限定该拼写不用于输入单字
```

### 6. 缩略（abbrev）

**功能**：创建缩写拼写，在音节切分时与通常拼写区分处理

**格式**：`abbrev/<模式>/<替换式>/`

**示例**：
```yaml
abbrev/^([a-z]).+$/$1/        # 首字母缩写
abbrev/^([zcs]h).+$/$1/       # zh, ch, sh缩写
```

**效果**：以首字母为多字母音节码的缩写

## 投影算法

投影操作将音节表上的初始拼写法逐步推导为有效拼写集合。

### 算法描述

记音节表为 A，拼写运算序列为 [x, y, z]，投影结果记为 P[x,y,z](A → A)

```
Sa = { a → a | for a in A } = (A → A)
Sx = P<x>(Sa) = { x(a) → a | for (a → a) in (A → A) } = (B → A)
Sy = P<y>(Sx) = { y(b) → a | for (b → a) in (B → A) } = (C → A)
Sz = P<z>(Sy) = { z(c) → a | for (c → a) in (C → A) } = (D → A)
P[x,y,z](Sa) = Sz
```

### 执行过程

1. 从音节表 A 的初始拼写法开始（A → A）
2. 依次应用每个拼写运算
3. 每步产生新的有效拼写集合
4. 最终得到完整的拼写法映射

## 实际应用示例

### 朙月拼音方案（luna_pinyin.schema.yaml）

#### 拼写运算配置

```yaml
speller:
  algebra:
    # 简拼（首字母）
    - abbrev/^([a-z]).+$/$1/
    # 简拼（zh, ch, sh）
    - abbrev/^([zcs]h).+$/$1/
    
    # 容错拼写
    - derive/^([nl])ve$/$1ue/         # nue=nve, lue=lve
    - derive/ui$/uei/                 # guei=gui
    - derive/iu$/iou/                 # jiou=jiu
    - derive/([aeiou])ng$/$1gn/       # dagn=dang
    - derive/ong$/on/                 # zhonguo=zhong guo
    - derive/ao$/oa/                  # hoa=hao
    - derive/([iu])a(o|ng?)$/a$1$2/   # tain=tian
```

#### 编码回显配置

```yaml
translator:
  preedit_format:
    - xform/([nl])v/$1ü/  # 显示ü字母
```

### 模糊音配置示例

```yaml
speller:
  algebra:
    # 平翘舌不分
    - derive/^([zcs])h/$1/
    - derive/^([zcs])([^h])/$1h$2/
    
    # 鼻边音不分
    - derive/^n/l/
    - derive/^l/n/
    
    # 前后鼻音不分
    - derive/([ei])n$/$1ng/
    - derive/([ei])ng$/$1n/
    
    # 模糊音定义先于简拼定义，可令简拼支持以上模糊音
    - abbrev/^([a-z]).+$/$1/
    - abbrev/^([zcs]h).+$/$1/
```

### 倉頡输入方案（cangjie5.schema.yaml）

```yaml
translator:
  preedit_format:
    # 显示倉頡字母
    - xlit|abcdefghijklmnopqrstuvwxyz|日月金木水火土竹戈十大中一弓人心手口尸廿山女田難卜符|
```

## 配置要点

### 1. 运算顺序很重要

```yaml
speller:
  algebra:
    # ✓ 正确：模糊音定义在前
    - derive/^([zcs])h/$1/
    - abbrev/^([a-z]).+$/$1/
    
    # ✗ 错误：简拼在前会导致模糊音不生效
    - abbrev/^([a-z]).+$/$1/
    - derive/^([zcs])h/$1/
```

### 2. 正则表达式语法

- 支持标准regex语法
- 使用捕获组 `()` 和反向引用 `$1`, `$2`
- 使用锚点 `^` 和 `$` 匹配开头和结尾
- 使用字符类 `[a-z]`, `[aeiou]` 等

### 3. 编译时处理

- 拼写运算在方案部署时执行
- 生成Prism文件供运行时快速查询
- 修改配置后需要重新部署方案

### 4. 性能考虑

- 投影操作在编译时完成，不影响输入性能
- 运行时只需查询预计算的拼写法
- 合理设计运算规则，避免生成过多无效拼写

## 调试工具

### 输入方案部署工具

将投影所得的拼写法制成Prism文件，供RIME输入法快速访问。

### 拼写运算调试器

用于创作输入方案时调试算式、验证运算结果（已停止开发）。

**在线工具**：http://rime.github.io/blog/2013/08/28/spelling-algebra-debugger/

## 技术细节

### 运算类型对比

| 运算子 | 原拼写 | 新拼写 | 属性 | 用途 |
|--------|--------|--------|------|------|
| xlit   | 替换   | -      | -    | 字母转换 |
| xform  | 替换   | -      | -    | 格式变换 |
| erase  | 删除   | -      | -    | 排除编码 |
| derive | 保留   | 添加   | 等效 | 模糊音、容错 |
| fuzz   | 保留   | 添加   | 模糊 | 构词简码 |
| abbrev | 保留   | 添加   | 缩略 | 简拼 |

### 匹配模式

- **完全匹配**（erase）：regex match操作
- **部分匹配**（xform, derive, fuzz, abbrev）：regex search/global replace操作

### 编码处理

- **UTF-32编码**：仅xlit运算（支持非ASCII字符）
- **UTF-8编码**：其他所有运算

## 最佳实践

### 1. 合理组织运算顺序

```yaml
speller:
  algebra:
    # 第一步：基础容错
    - derive/^([nl])ve$/$1ue/
    
    # 第二步：模糊音
    - derive/^([zcs])h/$1/
    - derive/^n/l/
    
    # 第三步：简拼（放在最后）
    - abbrev/^([a-z]).+$/$1/
```

### 2. 避免过度派生

```yaml
# ✗ 不推荐：生成过多无效拼写
- derive/([a-z])/$1$1/  # 所有字母重复

# ✓ 推荐：针对性容错
- derive/ui$/uei/
- derive/iu$/iou/
```

### 3. 测试验证

- 部署方案后测试各种输入情况
- 检查是否产生意外的候选
- 验证音节切分是否正确

### 4. 文档注释

```yaml
speller:
  algebra:
    # 平翘舌不分
    - derive/^([zcs])h/$1/    # zh→z, ch→c, sh→s
    
    # 鼻边音不分
    - derive/^n/l/            # n→l
    - derive/^l/n/            # l→n
```

## 常见问题

### Q: 为什么模糊音不生效？

A: 检查运算顺序，模糊音定义应在简拼之前。

### Q: 如何只在构词时使用简码？

A: 使用 `fuzz` 运算并配合 `strict_spelling: true`。

### Q: 拼写运算会影响输入速度吗？

A: 不会。运算在编译时完成，运行时只查询预计算结果。

### Q: 如何调试拼写运算？

A: 使用在线调试器或查看生成的Prism文件。

## 参考资源

- [RIME官网](https://rime.im)
- [RIME官方讨论页](https://rime.im/discuss)
- [GitHub Wiki原文](https://github.com/rime/home/wiki/SpellingAlgebra)

## 总结

拼寫運算是RIME输入法的核心技术，通过灵活的规则系统实现：

- ✓ 简拼支持
- ✓ 模糊音处理
- ✓ 容错拼写
- ✓ 自动音节切分
- ✓ 个性化定制

掌握拼寫運算，就能充分发挥RIME的强大定制能力，打造最适合自己的输入方案。
