# contextual_group_by_type é…ç½®è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æ–°å¢é…ç½®é€‰é¡¹ `contextual_group_by_type`ï¼Œç”¨äºæ§åˆ¶ ContextualTranslation æ˜¯å¦æŒ‰å€™é€‰ç±»å‹åˆ†ç»„æ’åºã€‚

---

## ğŸ“ é…ç½®æ–¹å¼

### é…ç½®æ–‡ä»¶ä½ç½®

åœ¨ä½ çš„è¾“å…¥æ–¹æ¡ˆé…ç½®æ–‡ä»¶ä¸­ï¼ˆå¦‚ `wanxiang.schema.yaml`ï¼‰ï¼š

```yaml
translator:
  contextual_suggestions: true           # å¯ç”¨ä¸Šä¸‹æ–‡å»ºè®®
  contextual_group_by_type: false        # ä¸æŒ‰ç±»å‹åˆ†ç»„ï¼ˆæ¨èï¼‰
```

---

## ğŸ”§ é…ç½®é€‰é¡¹è¯´æ˜

### contextual_group_by_type

**ç±»å‹**ï¼š`boolean`

**é»˜è®¤å€¼**ï¼š`false`

**ä½œç”¨**ï¼šæ§åˆ¶ä¸Šä¸‹æ–‡å€™é€‰æ’åºæ—¶æ˜¯å¦æŒ‰ç±»å‹åˆ†ç»„

---

### é€‰é¡¹å€¼è¯´æ˜

#### `false`ï¼ˆæ¨èï¼Œé»˜è®¤å€¼ï¼‰

**è¡Œä¸º**ï¼š
- å€™é€‰å®Œå…¨æŒ‰ä¸Šä¸‹æ–‡è¯„åˆ†æ’åº
- ä¸è€ƒè™‘å€™é€‰ç±»å‹ï¼ˆphrase, user_phrase, table, user_tableï¼‰
- Octagram è¯„åˆ†å®Œå…¨ä¸»å¯¼æ’åº

**ä¼˜ç‚¹**ï¼š
- âœ… çœŸæ­£çš„æƒé‡æ’åº
- âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ›´å‡†ç¡®
- âœ… ç¬¦åˆç”¨æˆ·æœŸæœ›ï¼ˆå¦‚"å®¶åº­"çš„"åº­"ä¼šæ’ç¬¬ä¸€ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å¸Œæœ›ä¸Šä¸‹æ–‡è¯„åˆ†å®Œå…¨ä¸»å¯¼æ’åº
- è¿½æ±‚æœ€ä½³çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ•ˆæœ
- å¤§å¤šæ•°ç”¨æˆ·æ¨èä½¿ç”¨

**ç¤ºä¾‹**ï¼š
```
è¾“å…¥: "jia" â†’ "å®¶"
è¾“å…¥: "ting"

å€™é€‰æ’åºï¼ˆæŒ‰æƒé‡ï¼‰:
1. åº­ (phrase, weight=-6.48)      â† ä¸Šä¸‹æ–‡æœ€ä¼˜
2. å¬ (user_phrase, weight=-24.75)
3. æŒº (phrase, weight=-29.82)
```

---

#### `true`ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰

**è¡Œä¸º**ï¼š
- å€™é€‰æŒ‰ç±»å‹åˆ†ç»„
- æ¯ç»„å†…éƒ¨æŒ‰ä¸Šä¸‹æ–‡è¯„åˆ†æ’åº
- ä¿æŒç±»å‹ä¼˜å…ˆçº§ï¼ˆuser_phrase > phrase > user_table > tableï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç”¨æˆ·è¯ç»„ä¼˜å…ˆæ˜¾ç¤º
- âœ… ä¸æ—§ç‰ˆæœ¬è¡Œä¸ºä¸€è‡´
- âœ… ä¿å®ˆç­–ç•¥ï¼Œé£é™©ä½

**ç¼ºç‚¹**ï¼š
- âŒ ä¸Šä¸‹æ–‡è¯„åˆ†ä½œç”¨æœ‰é™
- âŒ å¯èƒ½æ— æ³•å°†æœ€ä¼˜å€™é€‰æ’åˆ°ç¬¬ä¸€ä½

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦ä¿æŒä¸æ—§ç‰ˆæœ¬å…¼å®¹
- å¸Œæœ›ç”¨æˆ·è¯ç»„å§‹ç»ˆä¼˜å…ˆ
- ä¿å®ˆç”¨æˆ·

**ç¤ºä¾‹**ï¼š
```
è¾“å…¥: "jia" â†’ "å®¶"
è¾“å…¥: "ting"

å€™é€‰æ’åºï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰:
ç»„1 (user_phrase):
  1. å¬ (weight=-24.75)           â† ç”¨æˆ·è¯ç»„ä¼˜å…ˆ

ç»„2 (phrase):
  2. åº­ (weight=-6.48)            â† è™½ç„¶è¯„åˆ†æœ€é«˜ï¼Œä½†æ’åœ¨åé¢
  3. æŒº (weight=-29.82)
```

---

## ğŸ“Š é…ç½®å¯¹æ¯”

| é…ç½® | æ’åºæ–¹å¼ | ä¸Šä¸‹æ–‡æ•ˆæœ | ç”¨æˆ·è¯ç»„ä¼˜å…ˆçº§ | æ¨èåº¦ |
|------|---------|-----------|--------------|--------|
| `false` | å®Œå…¨æŒ‰æƒé‡ | â­â­â­â­â­ | ä¸­ç­‰ï¼ˆå–å†³äºæƒé‡ï¼‰ | â­â­â­â­â­ |
| `true` | æŒ‰ç±»å‹åˆ†ç»„ | â­â­â­ | é«˜ï¼ˆå§‹ç»ˆä¼˜å…ˆï¼‰ | â­â­â­ |

---

## ğŸ¨ å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šè¾“å…¥"å®¶åº­"

**åœºæ™¯**ï¼š
```
è¾“å…¥: "jia" â†’ é€‰æ‹© "å®¶"
è¾“å…¥: "ting"
```

**å€™é€‰**ï¼š
- å¬ (user_phrase, è¯å…¸æƒé‡=-6.75, ä¸Šä¸‹æ–‡è¯„åˆ†=-18.0, æœ€ç»ˆ=-24.75)
- åº­ (phrase, è¯å…¸æƒé‡=-11.84, ä¸Šä¸‹æ–‡è¯„åˆ†=+5.36, æœ€ç»ˆ=-6.48)
- æŒº (phrase, è¯å…¸æƒé‡=-11.82, ä¸Šä¸‹æ–‡è¯„åˆ†=-18.0, æœ€ç»ˆ=-29.82)

---

#### `contextual_group_by_type: false`ï¼ˆæ¨èï¼‰

```
1. [åº­]  â† ä¸Šä¸‹æ–‡æœ€ä¼˜ï¼ˆ"å®¶åº­"æ˜¯å¸¸è§æ­é…ï¼‰âœ…
2.  å¬
3.  æŒº
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âœ… ä¸€æ¬¡å‘½ä¸­ï¼Œæ— éœ€ç¿»é¡µ
- âœ… ç¬¦åˆé¢„æœŸ

---

#### `contextual_group_by_type: true`

```
1. [å¬]  â† user_phrase ä¼˜å…ˆ
2.  åº­   â† è™½ç„¶ä¸Šä¸‹æ–‡æœ€ä¼˜ï¼Œä½†æ’ç¬¬äºŒ
3.  æŒº
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âŒ éœ€è¦ç¿»é¡µé€‰æ‹©"åº­"
- âŒ ä¸ç¬¦åˆé¢„æœŸ

---

### æ¡ˆä¾‹2ï¼šç”¨æˆ·ç»å¸¸ä½¿ç”¨çš„è¯

**åœºæ™¯**ï¼š
```
è¾“å…¥: "wo"
ä¸Šä¸‹æ–‡: "ä½ "
```

**å€™é€‰**ï¼š
- æˆ‘ (user_phrase, è¯å…¸æƒé‡=-5.0, ä¸Šä¸‹æ–‡è¯„åˆ†=-12.0, æœ€ç»ˆ=-17.0)
- çª (phrase, è¯å…¸æƒé‡=-8.0, ä¸Šä¸‹æ–‡è¯„åˆ†=-12.0, æœ€ç»ˆ=-20.0)

---

#### `contextual_group_by_type: false`

```
1. [æˆ‘]  â† æƒé‡æœ€é«˜ï¼ˆç”¨æˆ·è¯ç»„æœ¬èº«æƒé‡é«˜ï¼‰âœ…
2.  çª
```

**ç»“è®º**ï¼šå³ä½¿ä¸æŒ‰ç±»å‹åˆ†ç»„ï¼Œç”¨æˆ·è¯ç»„ä»ç„¶ä¼˜å…ˆï¼ˆå› ä¸ºæƒé‡é«˜ï¼‰

---

#### `contextual_group_by_type: true`

```
1. [æˆ‘]  â† user_phrase ä¼˜å…ˆ
2.  çª
```

**ç»“è®º**ï¼šç»“æœç›¸åŒ

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### å®ç°åŸç†

#### `contextual_group_by_type: false`

```cpp
// åªæŒ‰ç»“æŸä½ç½®åˆ†ç»„
if (end_pos != cand->end()) {
  AppendToCache(queue);  // æ’åºå½“å‰ç»„
}
```

**åˆ†ç»„æ¡ä»¶**ï¼š
- ç»“æŸä½ç½®ä¸åŒ

**æ’åºèŒƒå›´**ï¼š
- æ‰€æœ‰ç›¸åŒç»“æŸä½ç½®çš„å€™é€‰åœ¨ä¸€ç»„
- ç»„å†…æŒ‰æƒé‡é™åºæ’åº

---

#### `contextual_group_by_type: true`

```cpp
// æŒ‰ç»“æŸä½ç½® AND ç±»å‹åˆ†ç»„
if (end_pos != cand->end() || last_type != cand->type()) {
  AppendToCache(queue);  // æ’åºå½“å‰ç»„
}
```

**åˆ†ç»„æ¡ä»¶**ï¼š
- ç»“æŸä½ç½®ä¸åŒ **OR** ç±»å‹ä¸åŒ

**æ’åºèŒƒå›´**ï¼š
- ç›¸åŒç»“æŸä½ç½® **AND** ç›¸åŒç±»å‹çš„å€™é€‰åœ¨ä¸€ç»„
- ç»„å†…æŒ‰æƒé‡é™åºæ’åº
- ç»„ä¹‹é—´ä¿æŒåŸå§‹é¡ºåºï¼ˆç±»å‹ä¼˜å…ˆçº§ï¼‰

---

### å€™é€‰ç±»å‹ä¼˜å…ˆçº§ï¼ˆéšå«ï¼‰

```
user_phrase  (ç”¨æˆ·è¯ç»„)
    â†“
phrase       (ç³»ç»Ÿè¯ç»„)
    â†“
user_table   (ç”¨æˆ·è¡¨è¯)
    â†“
table        (ç³»ç»Ÿè¡¨è¯)
    â†“
completion   (è¡¥å…¨)
```

**æ³¨æ„**ï¼š
- `contextual_group_by_type: false` æ—¶ï¼Œæ­¤ä¼˜å…ˆçº§ä¸ç”Ÿæ•ˆ
- `contextual_group_by_type: true` æ—¶ï¼Œæ­¤ä¼˜å…ˆçº§ç”Ÿæ•ˆ

---

## ğŸ› ï¸ é…ç½®ç¤ºä¾‹

### æ¨èé…ç½®ï¼ˆå®Œæ•´ï¼‰

```yaml
# wanxiang.schema.yaml

translator:
  # åŸºç¡€é…ç½®
  dictionary: wanxiang
  enable_sentence: true
  enable_completion: true
  
  # ä¸Šä¸‹æ–‡é…ç½®
  contextual_suggestions: true        # å¯ç”¨ä¸Šä¸‹æ–‡å»ºè®®
  contextual_group_by_type: false     # ä¸æŒ‰ç±»å‹åˆ†ç»„ï¼ˆæ¨èï¼‰

grammar:
  language: zh-hans                   # ä½¿ç”¨ç®€ä½“ä¸­æ–‡è¯­æ³•æ¨¡å‹
  collocation_min_length: 2
  non_collocation_penalty: -18        # æ— æ­é…æƒ©ç½šï¼ˆå¢å¤§ï¼‰
  weak_collocation_penalty: -24       # å¼±æ­é…æƒ©ç½š
  collocation_penalty: -6             # å¼ºæ­é…æƒ©ç½šï¼ˆå‡å°ï¼‰
```

---

### ä¿å®ˆé…ç½®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰

```yaml
# wanxiang.schema.yaml

translator:
  contextual_suggestions: true        # å¯ç”¨ä¸Šä¸‹æ–‡å»ºè®®
  contextual_group_by_type: true      # æŒ‰ç±»å‹åˆ†ç»„ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰

grammar:
  language: zh-hans
  # ä½¿ç”¨é»˜è®¤æƒ©ç½šå€¼
```

---

## ğŸ“‹ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬è¿ç§»

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬ï¼ˆæ²¡æœ‰ `contextual_group_by_type` é€‰é¡¹ï¼‰ï¼š

#### æ­¥éª¤1ï¼šæ›´æ–°é…ç½®

```yaml
# æ—§é…ç½®
translator:
  contextual_suggestions: true

# æ–°é…ç½®ï¼ˆæ¨èï¼‰
translator:
  contextual_suggestions: true
  contextual_group_by_type: false     # æ–°å¢
```

---

#### æ­¥éª¤2ï¼šæµ‹è¯•

```bash
# é‡æ–°éƒ¨ç½²
./rime_deployer --build user_profile

# æµ‹è¯•
./rime_console
# è¾“å…¥ "jia" â†’ "å®¶"
# è¾“å…¥ "ting"
# æœŸæœ›ï¼šåº­ æ’ç¬¬ä¸€
```

---

#### æ­¥éª¤3ï¼šå¦‚æœä¸é€‚åº”

å¦‚æœä¸é€‚åº”æ–°çš„æ’åºæ–¹å¼ï¼Œå¯ä»¥æ”¹å›ï¼š

```yaml
translator:
  contextual_suggestions: true
  contextual_group_by_type: true      # æ”¹å›æ—§è¡Œä¸º
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆé»˜è®¤å€¼æ˜¯ `false`ï¼Ÿ

**A**: å› ä¸º `false` å¯ä»¥è®©ä¸Šä¸‹æ–‡è¯„åˆ†å®Œå…¨å‘æŒ¥ä½œç”¨ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

---

### Q2: è®¾ç½®ä¸º `false` åï¼Œç”¨æˆ·è¯ç»„è¿˜ä¼šä¼˜å…ˆå—ï¼Ÿ

**A**: ä¼šçš„ï¼ç”¨æˆ·è¯ç»„é€šå¸¸æœ‰æ›´é«˜çš„è¯å…¸æƒé‡ï¼ˆ+0.5 åŠ æˆï¼‰ï¼Œæ‰€ä»¥åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä»ç„¶ä¼šæ’åœ¨å‰é¢ã€‚åªæœ‰å½“ä¸Šä¸‹æ–‡è¯„åˆ†å·®è·å¾ˆå¤§æ—¶ï¼Œæ‰ä¼šè¢«å…¶ä»–å€™é€‰è¶…è¶Šã€‚

---

### Q3: ä»€ä¹ˆæ—¶å€™åº”è¯¥è®¾ç½®ä¸º `true`ï¼Ÿ

**A**: 
- ä½ å¸Œæœ›ç”¨æˆ·è¯ç»„å§‹ç»ˆä¼˜å…ˆ
- ä½ éœ€è¦ä¸æ—§ç‰ˆæœ¬è¡Œä¸ºä¿æŒä¸€è‡´
- ä½ æ˜¯ä¿å®ˆç”¨æˆ·ï¼Œä¸æƒ³æ”¹å˜ä¹ æƒ¯

---

### Q4: è¿™ä¸ªé…ç½®ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

**A**: ä¸ä¼šã€‚ä¸¤ç§æ¨¡å¼çš„æ€§èƒ½åŸºæœ¬ç›¸åŒï¼ˆéƒ½æ˜¯ O(n log n)ï¼Œn â‰¤ 32ï¼‰ã€‚

---

### Q5: å¯ä»¥åŠ¨æ€åˆ‡æ¢å—ï¼Ÿ

**A**: å¯ä»¥ã€‚ä¿®æ”¹é…ç½®åï¼Œé‡æ–°éƒ¨ç½²å³å¯ï¼š

```bash
./rime_deployer --build user_profile
```

---

## ğŸ¯ æ¨èè®¾ç½®

### å¤§å¤šæ•°ç”¨æˆ·

```yaml
translator:
  contextual_suggestions: true
  contextual_group_by_type: false     # æ¨è
```

**ç†ç”±**ï¼š
- æ›´å¥½çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥
- å‡å°‘ç¿»é¡µæ¬¡æ•°
- æ›´æ™ºèƒ½çš„å€™é€‰æ’åº

---

### ä¿å®ˆç”¨æˆ·

```yaml
translator:
  contextual_suggestions: true
  contextual_group_by_type: true      # ä¿å®ˆ
```

**ç†ç”±**ï¼š
- ä¸æ—§ç‰ˆæœ¬è¡Œä¸ºä¸€è‡´
- ç”¨æˆ·è¯ç»„å§‹ç»ˆä¼˜å…ˆ
- é£é™©ä½

---

### ä¸ä½¿ç”¨ä¸Šä¸‹æ–‡å»ºè®®

```yaml
translator:
  contextual_suggestions: false       # ç¦ç”¨ä¸Šä¸‹æ–‡å»ºè®®
  # contextual_group_by_type æ— æ•ˆï¼ˆå› ä¸ºä¸Šä¸‹æ–‡å»ºè®®å·²ç¦ç”¨ï¼‰
```

**ç†ç”±**ï¼š
- ä¸éœ€è¦ä¸Šä¸‹æ–‡æ„ŸçŸ¥
- è¿½æ±‚æœ€å¿«é€Ÿåº¦
- æˆ–è€…æ²¡æœ‰è¯­æ³•æ¨¡å‹æ–‡ä»¶

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| é…ç½® | æ’åºæ¬¡æ•° | æ’åºæ•°æ®é‡ | è€—æ—¶ |
|------|---------|-----------|------|
| `false` | 1æ¬¡ | æœ€å¤š32ä¸ª | < 1ms |
| `true` | å¤šæ¬¡ | æ¯æ¬¡è¾ƒå° | < 1ms |

**ç»“è®º**ï¼šæ€§èƒ½å·®å¼‚å¯å¿½ç•¥ã€‚

---

## ğŸ”¬ è°ƒè¯•æ–¹æ³•

### æŸ¥çœ‹æ—¥å¿—

å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼š

```bash
export RIME_LOG_DIR=/tmp/rime_logs
./rime_console
```

æŸ¥çœ‹åˆ†ç»„ä¿¡æ¯ï¼š

```bash
tail -f /tmp/rime_logs/rime.console.*.log | grep "appending to cache"
```

**`contextual_group_by_type: false`**ï¼š
```
appending to cache 32 candidates.  â† åªæœ‰ä¸€ç»„
```

**`contextual_group_by_type: true`**ï¼š
```
appending to cache 1 candidates.   â† ç»„1: user_phrase
appending to cache 31 candidates.  â† ç»„2: phrase
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ–°å¢é…ç½®**ï¼š`contextual_group_by_type`
2. **é»˜è®¤å€¼**ï¼š`false`ï¼ˆä¸æŒ‰ç±»å‹åˆ†ç»„ï¼‰
3. **æ¨èè®¾ç½®**ï¼š`false`ï¼ˆæ›´å¥½çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼‰
4. **å…¼å®¹æ€§**ï¼šè®¾ç½®ä¸º `true` å¯ä»¥ä¿æŒæ—§ç‰ˆæœ¬è¡Œä¸º

### é€‰æ‹©å»ºè®®

- âœ… **è¿½æ±‚æœ€ä½³ä½“éªŒ** â†’ `false`
- âœ… **ä¿å®ˆç”¨æˆ·** â†’ `true`
- âœ… **ä¸ç¡®å®š** â†’ å…ˆè¯• `false`ï¼Œä¸é€‚åº”å†æ”¹å› `true`

### é…ç½®æ¨¡æ¿

```yaml
# æ¨èé…ç½®
translator:
  contextual_suggestions: true
  contextual_group_by_type: false

grammar:
  language: zh-hans
  non_collocation_penalty: -18
  collocation_penalty: -6
```
