# 日志分析：为什么"庭"没有排第一？真正的问题

## 🎯 关键发现

**好消息**：`contextual_suggestions` 已经启用，Octagram 正在工作！

**坏消息**：虽然 Octagram 给"庭"打了高分，但"听"的最终权重仍然更高！

---

## 📊 日志分析

### 关键日志1：听的评分

```
I20251017 01:43:09.524864 contextual_translation.cc:18] 听 cache/queue: 0/0
I20251017 01:43:09.524882 octagram.cc:129] Lookup(家 + 听) returns 0 results
I20251017 01:43:09.524889 octagram.cc:159] context = 家, word = 听 / -12
I20251017 01:43:09.524895 contextual_translation.cc:46] contextual suggestion: 听 weight: -18.7421
```

**解读**：
- Octagram 查询：`Lookup(家 + 听)` → 没有找到搭配
- 上下文评分：`-12`（默认惩罚）
- **最终权重：`-18.7421`**

---

### 关键日志2：庭的评分

```
I20251017 01:43:09.526460 contextual_translation.cc:18] 庭 cache/queue: 1/30
I20251017 01:43:09.526467 octagram.cc:129] Lookup(家 + 庭) returns 1 results
I20251017 01:43:09.526470 octagram.cc:134] match[2] = 11.357
I20251017 01:43:09.526473 octagram.cc:144] update: 家[1] + 庭[1] = -0.643
I20251017 01:43:09.526480 octagram.cc:159] context = 家, word = 庭 / -0.643
I20251017 01:43:09.526484 contextual_translation.cc:46] contextual suggestion: 庭 weight: -12.4803
```

**解读**：
- Octagram 查询：`Lookup(家 + 庭)` → **找到1个搭配** ✅
- 匹配值：`11.357`
- 上下文评分：`-0.643`（强搭配！）
- **最终权重：`-12.4803`**

---

## 🔑 问题根源

### 权重对比

| 候选 | 词典权重 | 上下文评分 | 最终权重 | 排名 |
|------|---------|-----------|---------|------|
| **听** | **-6.7421** | -12.0 | **-18.7421** | **1** ❌ |
| 庭 | -11.8373 | -0.643 | -12.4803 | 2 |

**关键发现**：
- ✅ Octagram 工作正常（"庭"得到 `-0.643` 高分）
- ✅ 上下文评分正确（"家庭"是强搭配）
- ❌ **但"听"的词典权重太高了！**（`-6.7421` vs `-11.8373`）

---

## 💡 问题分析

### 为什么"听"的词典权重这么高？

#### 可能原因1：用户词典中"听"的使用频率很高

```
词典权重 = log(词频) + 用户调整
```

如果你经常使用"听"这个字，用户词典会提升它的权重。

---

#### 可能原因2：词典权重差距太大

```
听: -6.7421  (词频很高)
庭: -11.8373 (词频中等)
差距: 5.0952  ← 差距太大！
```

即使 Octagram 给"庭"加了 `11.357` 的上下文分（`-0.643` vs `-12.0`），也无法弥补 `5.0952` 的词频差距。

---

### 计算验证

```
听的最终权重:
  = 词典权重 + 上下文评分
  = -6.7421 + (-12.0)
  = -18.7421

庭的最终权重:
  = 词典权重 + 上下文评分
  = -11.8373 + (-0.643)
  = -12.4803

差距:
  -12.4803 - (-18.7421) = 6.2618
```

**结论**：虽然"庭"的上下文评分高了 `11.357`，但"听"的词典权重高了 `5.0952`，最终"听"仍然排第一。

---

## 🎨 为什么会这样？

### Octagram 的设计理念

Octagram 的上下文评分范围是 **`-12` 到 `0`**：
- 强搭配：`-2` 到 `0`
- 弱搭配：`-12` 到 `-24`
- 无搭配：`-12`（默认惩罚）

**问题**：这个范围相对较小，只有 `12` 的差距。

如果词典权重差距超过 `12`，即使是强搭配也无法逆转排名。

---

### 实际案例

```
场景1：词典权重差距小（正常）
  听: -5.0 + (-12.0) = -17.0
  庭: -6.0 + (-0.6) = -6.6  ← 庭排第一 ✅

场景2：词典权重差距大（你的情况）
  听: -6.7 + (-12.0) = -18.7  ← 听排第一 ❌
  庭: -11.8 + (-0.6) = -12.5
```

---

## 🛠️ 解决方案

### 方案1：降低"听"的词典权重（推荐）

如果"听"在用户词典中被过度提升，可以手动调整：

```bash
# 查看用户词典
cd /Users/jimmy54/Pictures/jimmy_librime/librime/cmake-build-debug/bin
cat user_profile/wanxiang.userdb.txt | grep "听"

# 如果发现"听"的使用次数很高，可以：
# 1. 删除用户词典重新训练
rm user_profile/wanxiang.userdb.*
./rime_deployer --build user_profile

# 2. 或手动编辑用户词典（不推荐）
```

---

### 方案2：增大 Octagram 的上下文评分权重

修改配置文件，调整惩罚值：

```yaml
# wanxiang.schema.yaml
grammar:
  language: zh-hans
  collocation_min_length: 2
  non_collocation_penalty: -18    # 增大无搭配惩罚（默认 -12）
  weak_collocation_penalty: -30   # 增大弱搭配惩罚（默认 -24）
  collocation_penalty: -6         # 减小强搭配惩罚（默认 -12）
```

**效果**：
```
调整前:
  听: -6.7 + (-12.0) = -18.7  ← 第一
  庭: -11.8 + (-0.6) = -12.5

调整后:
  听: -6.7 + (-18.0) = -24.7
  庭: -11.8 + (-0.6) = -12.4  ← 第一 ✅
```

---

### 方案3：使用 ContextualRankingFilter 增强

在 Filter 层再次评分，增大上下文权重：

```yaml
# wanxiang.schema.yaml
engine:
  filters:
    - contextual_ranking_filter@left   # 左上下文
    - contextual_ranking_filter@right  # 右上下文
    - uniquifier

contextual_ranking_filter:
  grammar: grammar
  boost_factor: 2.0  # 上下文权重加倍
```

**效果**：
```
第一次评分（ContextualTranslation）:
  听: -6.7 + (-12.0) = -18.7
  庭: -11.8 + (-0.6) = -12.5

第二次评分（ContextualRankingFilter，boost_factor=2.0）:
  听: -18.7 + (-12.0 * 2.0) = -42.7
  庭: -12.5 + (-0.6 * 2.0) = -13.7  ← 第一 ✅
```

---

### 方案4：调整词典权重（治本）

如果"听"的词频确实过高，可以编辑系统词典：

```bash
# 编辑词典文件
vim /Users/jimmy54/Pictures/jimmy_librime/librime/cmake-build-debug/bin/wanxiang.dict.yaml

# 找到"听"的条目
听	ting	100000  # 词频

# 降低词频
听	ting	10000   # 降低10倍

# 重新部署
./rime_deployer --build user_profile
```

---

## 📊 推荐方案对比

| 方案 | 难度 | 效果 | 副作用 |
|------|------|------|--------|
| **方案1：重置用户词典** | 简单 | 中等 | 丢失用户习惯 |
| **方案2：调整 Octagram 参数** | 简单 | 好 | 可能影响其他词 |
| **方案3：增加 Filter** | 中等 | 很好 | 性能开销 |
| **方案4：修改系统词典** | 复杂 | 最好 | 需要重新部署 |

---

## 🎯 我的建议

### 短期方案（立即见效）

**调整 Octagram 参数**：

```yaml
# wanxiang.schema.yaml
grammar:
  language: zh-hans
  non_collocation_penalty: -18    # 从 -12 改为 -18
  collocation_penalty: -6         # 从 -12 改为 -6
```

重新部署：
```bash
./rime_deployer --build user_profile
```

**预期效果**：
```
听: -6.7 + (-18.0) = -24.7
庭: -11.8 + (-0.6) = -12.4  ← 第一 ✅
```

---

### 长期方案（最佳）

**结合方案2和方案3**：

1. 调整 Octagram 参数（增大上下文权重）
2. 添加 ContextualRankingFilter（二次评分）
3. 定期清理用户词典（避免过度学习）

---

## 📋 验证步骤

### 1. 查看当前配置

```bash
cd /Users/jimmy54/Pictures/jimmy_librime/librime/cmake-build-debug/bin
grep -A5 "grammar:" user_profile/build/wanxiang.schema.yaml
```

### 2. 修改配置

```yaml
grammar:
  language: zh-hans
  non_collocation_penalty: -18
  collocation_penalty: -6
```

### 3. 重新部署

```bash
./rime_deployer --build user_profile
```

### 4. 测试

```bash
./rime_console

# 输入 "jia" 选择 "家"
# 输入 "ting"
# 查看候选列表
```

### 5. 查看日志

```bash
tail -f user_profile/log/rime.console.*.log | grep "contextual suggestion"
```

**期望看到**：
```
contextual suggestion: 听 weight: -24.7
contextual suggestion: 庭 weight: -12.4  ← 权重更高
```

---

## 🔍 深层原因分析

### 为什么官方 Octagram 的权重范围这么小？

1. **平衡性考虑**
   - 上下文评分不应该完全主导排序
   - 词频仍然是重要因素
   - 避免过度依赖语法模型

2. **数据质量问题**
   - 语法模型可能不完整
   - 某些搭配可能缺失
   - 需要保留词频作为后备

3. **性能考虑**
   - 较小的权重范围更稳定
   - 避免极端情况
   - 减少计算开销

---

### 你的情况特殊在哪里？

1. **词典权重差距大**
   - "听"：`-6.7421`（高频词）
   - "庭"：`-11.8373`（中频词）
   - 差距：`5.0952`

2. **用户词典影响**
   - 可能经常使用"听"
   - 用户词典提升了"听"的权重

3. **Octagram 权重不足**
   - 上下文评分只有 `11.357` 的差距
   - 无法弥补 `5.0952` 的词频差距

---

## 🎯 总结

### 问题根源

1. ✅ `contextual_suggestions` 已启用
2. ✅ Octagram 正常工作
3. ✅ "家庭"被识别为强搭配（`-0.643`）
4. ❌ **"听"的词典权重太高**（`-6.7421`）
5. ❌ **Octagram 的上下文评分范围太小**（`-12` 到 `0`）

### 解决方法

**推荐方案**：调整 Octagram 参数

```yaml
grammar:
  non_collocation_penalty: -18  # 增大无搭配惩罚
  collocation_penalty: -6       # 减小强搭配惩罚
```

**预期效果**：
- 听：`-6.7 + (-18.0) = -24.7`
- 庭：`-11.8 + (-0.6) = -12.4` ← 第一 ✅

### 关键教训

**Octagram 不是万能的**：
- 它只能在一定范围内调整排序
- 如果词典权重差距太大，上下文评分可能无法逆转
- 需要平衡词频和上下文的权重

**你的 ContextualRankingFilter 可能更有效**：
- 可以自定义权重范围
- 可以增大上下文评分的影响
- 可以更激进地调整排序
