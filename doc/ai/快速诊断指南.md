# 上下文排序功能快速诊断指南

## 🚀 快速开始

如果你发现 `set_context_text` 设置上下文后没有效果，请按以下步骤操作：

---

## 第一步：运行诊断工具（5分钟）

```bash
# 1. 编译诊断工具
cd /Users/jimmy54/Pictures/jimmy_librime/librime
g++ -o diagnose diagnose_context_ranking.cc \
    -I/usr/local/include \
    -L/usr/local/lib \
    -lrime

# 2. 运行诊断
./diagnose

# 3. 查看日志
tail -100 /tmp/rime_logs/rime.INFO
```

---

## 第二步：根据诊断结果采取行动

### 情况A：日志中没有 "registering components from module 'grammar'"

**原因**：Grammar模块（Octagram插件）未加载

**解决**：
```bash
# 重新编译，包含octagram插件
cmake -B build -DBUILD_PLUGINS=ON
make -C build
sudo make -C build install
```

---

### 情况B：日志中没有 "ContextualRankingFilter"

**原因**：方案配置缺失

**解决**：编辑 `~/.config/rime/luna_pinyin.schema.yaml`

```yaml
engine:
  filters:
    - contextual_ranking_filter  # 添加这一行
    - simplifier
    - uniquifier

contextual_ranking_filter:
  contextual_ranking: true
  max_rerank_candidates: 20

grammar:
  language: zh-hant
  contextual_suggestions: true
```

然后重新部署：
```bash
# 在输入法中按 Ctrl+` 或 F4，选择"重新部署"
```

---

### 情况C：找不到 .gram 文件

**检查**：
```bash
find /usr/local/share/rime-data -name "*.gram"
find ~/.config/rime -name "*.gram"
```

**原因**：缺少语法数据库文件

**解决**：
1. 从 [librime-octagram](https://github.com/lotem/librime-octagram) 获取预训练模型
2. 或者训练自己的语法数据库

---

### 情况D：有日志但效果不明显

**原因**：上下文权重不足

**日志示例**：
```
Candidate: "反" quality=100 left=5 total=105
Candidate: "饭" quality=80 left=20 total=100
```

可以看到"饭"的上下文分数(left=20)高于"反"(left=5)，但总分仍然低。

**解决**：修改 `src/rime/gear/contextual_ranking_filter.cc` 第99行

```cpp
// 原代码
double total_score = cand->quality() + left_score + right_score;

// 修改为（增加上下文权重）
double total_score = cand->quality() * 0.5 +  // 降低原始质量权重
                     left_score * 3.0 +       // 增加左侧权重
                     right_score * 3.0;       // 增加右侧权重
```

然后重新编译：
```bash
make -C build
sudo make -C build install
```

---

## 第三步：验证修复

再次运行诊断工具：
```bash
./diagnose
```

查看输出，确认：
- ✅ "吃" + "fan" → "饭"排在第1位
- ✅ "一心一" + "yi" → "意"排在前面

---

## 📋 检查清单

在联系我之前，请确认以下内容：

- [ ] 已运行诊断工具 `./diagnose`
- [ ] 已查看日志文件 `/tmp/rime_logs/rime.INFO`
- [ ] 已检查是否存在 `.gram` 文件
- [ ] 已确认方案配置包含 `contextual_ranking_filter`
- [ ] 已尝试重新部署输入法

---

## 🆘 仍然无法解决？

请提供以下信息：

1. **诊断工具输出**：
   ```bash
   ./diagnose > diagnose_output.txt 2>&1
   ```

2. **日志文件**：
   ```bash
   tail -200 /tmp/rime_logs/rime.INFO > rime_log.txt
   ```

3. **方案配置**：
   ```bash
   cat ~/.config/rime/luna_pinyin.schema.yaml > schema_config.txt
   ```

4. **语法文件检查**：
   ```bash
   find /usr/local/share/rime-data -name "*.gram" -ls > gram_files.txt
   ```

将这4个文件发给我，我会帮你进一步分析。

---

## 📚 相关文档

- **详细分析**：[上下文排序问题分析.md](上下文排序问题分析.md)
- **调试指南**：[CONTEXT_RANKING_DEBUG.md](CONTEXT_RANKING_DEBUG.md)
- **使用说明**：[doc/CONTEXTUAL_RANKING.md](doc/CONTEXTUAL_RANKING.md)
- **实现总结**：[doc/IMPLEMENTATION_SUMMARY.md](doc/IMPLEMENTATION_SUMMARY.md)
