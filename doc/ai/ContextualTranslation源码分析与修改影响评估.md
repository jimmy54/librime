# ContextualTranslation æºç åˆ†æä¸ä¿®æ”¹å½±å“è¯„ä¼°

## ğŸ“š æºç æ·±åº¦è§£æ

### 1. ContextualTranslation çš„è®¾è®¡æ¶æ„

#### ç±»ç»§æ‰¿å…³ç³»

```cpp
ContextualTranslation : public PrefetchTranslation
                              â†“
                        Translation (åŸºç±»)
```

**PrefetchTranslation** çš„ç‰¹ç‚¹ï¼š
- é¢„å–å€™é€‰åˆ°ç¼“å­˜ï¼ˆ`cache_`ï¼‰
- é€šè¿‡ `Replenish()` æ–¹æ³•å¡«å……ç¼“å­˜
- æä¾› `Peek()` å’Œ `Next()` æ¥å£

---

### 2. æ ¸å¿ƒæ–¹æ³•åˆ†æ

#### Replenish() - å¡«å……ç¼“å­˜

```cpp
bool ContextualTranslation::Replenish() {
  vector<of<Phrase>> queue;      // å½“å‰åˆ†ç»„çš„å€™é€‰é˜Ÿåˆ—
  size_t end_pos = 0;            // ä¸Šä¸€ä¸ªå€™é€‰çš„ç»“æŸä½ç½®
  std::string last_type;         // ä¸Šä¸€ä¸ªå€™é€‰çš„ç±»å‹
  
  // é™åˆ¶å¤„ç† 32 ä¸ªå€™é€‰
  while (!translation_->exhausted() &&
         cache_.size() + queue.size() < kContextualSearchLimit) {
    
    auto cand = translation_->Peek();
    
    // åªå¤„ç†ç‰¹å®šç±»å‹çš„å€™é€‰
    if (cand->type() == "phrase" || cand->type() == "user_phrase" ||
        cand->type() == "table" || cand->type() == "user_table" ||
        cand->type() == "completion") {
      
      // â­ å…³é”®ï¼šåˆ†ç»„åˆ¤æ–­
      if (end_pos != cand->end() || last_type != cand->type()) {
        //                          ^^^^^^^^^^^^^^^^^^^^^^^^
        //                          ç±»å‹åˆ†ç»„æ¡ä»¶
        
        end_pos = cand->end();
        last_type = cand->type();
        AppendToCache(queue);  // æ’åºå¹¶æ·»åŠ å½“å‰ç»„åˆ°ç¼“å­˜
      }
      
      // è¯„åˆ†å¹¶åŠ å…¥å½“å‰ç»„
      queue.push_back(Evaluate(As<Phrase>(cand)));
      
    } else {
      // å…¶ä»–ç±»å‹ç›´æ¥æ·»åŠ åˆ°ç¼“å­˜
      AppendToCache(queue);
      cache_.push_back(cand);
    }
    
    translation_->Next();
  }
  
  // å¤„ç†æœ€åä¸€ç»„
  AppendToCache(queue);
  return !cache_.empty();
}
```

---

#### åˆ†ç»„é€»è¾‘è¯¦è§£

**åˆ†ç»„è§¦å‘æ¡ä»¶**ï¼š
```cpp
if (end_pos != cand->end() || last_type != cand->type())
```

**ä¸¤ä¸ªæ¡ä»¶ï¼ˆOR å…³ç³»ï¼‰**ï¼š
1. `end_pos != cand->end()`ï¼šç»“æŸä½ç½®ä¸åŒ
2. `last_type != cand->type()`ï¼š**ç±»å‹ä¸åŒ**

**åªè¦æ»¡è¶³ä»»ä¸€æ¡ä»¶ï¼Œå°±ä¼šè§¦å‘åˆ†ç»„**ã€‚

---

#### æ‰§è¡Œæµç¨‹ç¤ºä¾‹

```
è¾“å…¥åºåˆ—:
1. å¬ (user_phrase, end=1)
2. ä»– (phrase, end=1)
3. å¤´ (phrase, end=1)
4. åº­ (phrase, end=1)

æ‰§è¡Œè¿‡ç¨‹:

Step 1: å¬ (user_phrase, end=1)
  end_pos = 0, last_type = ""
  æ¡ä»¶: 0 != 1 || "" != "user_phrase" â†’ true
  â†’ è§¦å‘åˆ†ç»„ï¼ˆqueue ä¸ºç©ºï¼Œæ— æ“ä½œï¼‰
  â†’ æ›´æ–°: end_pos=1, last_type="user_phrase"
  â†’ åŠ å…¥ queue: [å¬]

Step 2: ä»– (phrase, end=1)
  end_pos = 1, last_type = "user_phrase"
  æ¡ä»¶: 1 != 1 || "user_phrase" != "phrase" â†’ false || true â†’ true
  â†’ è§¦å‘åˆ†ç»„ï¼
  â†’ AppendToCache([å¬]) â†’ æ’åºå¹¶æ·»åŠ åˆ° cache
  â†’ æ›´æ–°: end_pos=1, last_type="phrase"
  â†’ åˆ›å»ºæ–° queue: [ä»–]

Step 3: å¤´ (phrase, end=1)
  end_pos = 1, last_type = "phrase"
  æ¡ä»¶: 1 != 1 || "phrase" != "phrase" â†’ false || false â†’ false
  â†’ ä¸è§¦å‘åˆ†ç»„
  â†’ åŠ å…¥ queue: [ä»–, å¤´]

Step 4: åº­ (phrase, end=1)
  end_pos = 1, last_type = "phrase"
  æ¡ä»¶: 1 != 1 || "phrase" != "phrase" â†’ false
  â†’ ä¸è§¦å‘åˆ†ç»„
  â†’ åŠ å…¥ queue: [ä»–, å¤´, åº­]

Step 5: å¾ªç¯ç»“æŸ
  â†’ AppendToCache([ä»–, å¤´, åº­]) â†’ æ’åºå¹¶æ·»åŠ åˆ° cache

æœ€ç»ˆ cache:
  [å¬, åº­, ä»–, å¤´]
  â†‘    â†‘   â†‘   â†‘
  ç»„1  ç»„2æ’åºåçš„ç»“æœ
```

---

### 3. å€™é€‰ç±»å‹ç³»ç»Ÿ

#### ç±»å‹å®šä¹‰ä½ç½®

ä»ä»£ç æœç´¢ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå€™é€‰ç±»å‹åœ¨åˆ›å»ºæ—¶æŒ‡å®šï¼š

**TableTranslator**ï¼ˆè¡¨æ ¼ç¿»è¯‘å™¨ï¼‰ï¼š
```cpp
// table_translator.cc L83-85
auto type = incomplete       ? "completion"
            : is_user_phrase ? "user_table"
                             : "table";
```

**ScriptTranslator**ï¼ˆè„šæœ¬ç¿»è¯‘å™¨ï¼‰ï¼š
```cpp
// script_translator.cc L599
"user_phrase"  // ç”¨æˆ·è¯ç»„

// script_translator.cc L613
"phrase"       // ç³»ç»Ÿè¯ç»„
```

---

#### ç±»å‹ä¼˜å…ˆçº§ï¼ˆéšå«ï¼‰

ä» Translator çš„è¾“å‡ºé¡ºåºæ¥çœ‹ï¼š

```
1. user_phrase   (ç”¨æˆ·è¯ç»„ - æœ€é«˜ä¼˜å…ˆçº§)
   â†“
2. phrase        (ç³»ç»Ÿè¯ç»„)
   â†“
3. user_table    (ç”¨æˆ·è¡¨è¯)
   â†“
4. table         (ç³»ç»Ÿè¡¨è¯)
   â†“
5. completion    (è¡¥å…¨)
```

**åŸå› **ï¼š
- `user_phrase` é€šå¸¸æœ‰æ›´é«˜çš„ qualityï¼ˆ+0.5 åŠ æˆï¼‰
- Translator æŒ‰ quality æ’åºè¾“å‡º
- ContextualTranslation æŒ‰è¾“å…¥é¡ºåºåˆ†ç»„

---

### 4. AppendToCache() - æ’åºå¹¶æ·»åŠ 

```cpp
void ContextualTranslation::AppendToCache(vector<of<Phrase>>& queue) {
  if (queue.empty())
    return;
  
  DLOG(INFO) << "appending to cache " << queue.size() << " candidates.";
  
  // â­ å…³é”®ï¼šç»„å†…æ’åºï¼ˆæŒ‰æƒé‡é™åºï¼‰
  std::sort(queue.begin(), queue.end(), compare_by_weight_desc);
  
  // æ·»åŠ åˆ°ç¼“å­˜
  std::copy(queue.begin(), queue.end(), std::back_inserter(cache_));
  
  // æ¸…ç©ºé˜Ÿåˆ—
  queue.clear();
}
```

**æ’åºè§„åˆ™**ï¼š
```cpp
static bool compare_by_weight_desc(const an<Phrase>& a, const an<Phrase>& b) {
  return a->weight() > b->weight();  // æƒé‡é™åº
}
```

---

### 5. Evaluate() - ä¸Šä¸‹æ–‡è¯„åˆ†

```cpp
an<Phrase> ContextualTranslation::Evaluate(an<Phrase> phrase) {
  bool is_rear = phrase->end() == input_.length();
  
  // è°ƒç”¨ Grammar::Evaluate è®¡ç®—æœ€ç»ˆæƒé‡
  double weight = Grammar::Evaluate(preceding_text_, phrase->text(),
                                    phrase->weight(), is_rear, grammar_);
  
  phrase->set_weight(weight);
  
  DLOG(INFO) << "contextual suggestion: " << phrase->text()
             << " weight: " << phrase->weight();
  
  return phrase;
}
```

**æƒé‡è®¡ç®—**ï¼š
```
æœ€ç»ˆæƒé‡ = è¯å…¸æƒé‡ + ä¸Šä¸‹æ–‡è¯„åˆ†
```

---

## ğŸ” æ–¹æ¡ˆ2ï¼šå–æ¶ˆç±»å‹åˆ†ç»„çš„å½±å“è¯„ä¼°

### ä¿®æ”¹å†…å®¹

```cpp
// ä¿®æ”¹å‰ï¼ˆL23ï¼‰
if (end_pos != cand->end() || last_type != cand->type()) {

// ä¿®æ”¹å
if (end_pos != cand->end()) {
```

**å˜åŒ–**ï¼šåˆ é™¤ `|| last_type != cand->type()` æ¡ä»¶

---

### å½±å“åˆ†æ

#### 1. æ­£é¢å½±å“ âœ…

##### 1.1 çœŸæ­£çš„æƒé‡æ’åº

**ä¿®æ”¹å‰**ï¼š
```
ç»„1 (user_phrase):
  å¬ (-24.75)

ç»„2 (phrase):
  åº­ (-6.48)
  ä»– (-23.64)

æœ€ç»ˆé¡ºåº: [å¬, åº­, ä»–]
```

**ä¿®æ”¹å**ï¼š
```
ç»„1 (end=1):
  åº­ (-6.48)   â† æœ€ä¼˜
  å¬ (-24.75)
  ä»– (-23.64)

æœ€ç»ˆé¡ºåº: [åº­, å¬, ä»–]  âœ…
```

**ç»“è®º**ï¼šå€™é€‰çœŸæ­£æŒ‰ä¸Šä¸‹æ–‡è¯„åˆ†æ’åºï¼Œä¸å—ç±»å‹é™åˆ¶ã€‚

---

##### 1.2 æ›´ç¬¦åˆç”¨æˆ·æœŸæœ›

**åœºæ™¯**ï¼šè¾“å…¥"å®¶åº­"

- ç”¨æˆ·æœŸæœ›ï¼š"åº­"æ’ç¬¬ä¸€ï¼ˆå› ä¸º"å®¶åº­"æ˜¯å¸¸è§æ­é…ï¼‰
- ä¿®æ”¹å‰ï¼šå³ä½¿"åº­"è¯„åˆ†æ›´é«˜ï¼Œä¹Ÿæ’åœ¨ user_phrase åé¢
- ä¿®æ”¹åï¼š"åº­"æ­£ç¡®æ’ç¬¬ä¸€ âœ…

---

##### 1.3 Octagram æ•ˆæœæœ€å¤§åŒ–

**Octagram çš„ç›®çš„**ï¼šæ ¹æ®ä¸Šä¸‹æ–‡è°ƒæ•´å€™é€‰æ’åº

- ä¿®æ”¹å‰ï¼šåˆ†ç»„é™åˆ¶äº† Octagram çš„ä½œç”¨èŒƒå›´
- ä¿®æ”¹åï¼šOctagram å¯ä»¥å®Œå…¨å‘æŒ¥ä½œç”¨ âœ…

---

#### 2. æ½œåœ¨é£é™© âš ï¸

##### 2.1 ç”¨æˆ·è¯ç»„ä¼˜å…ˆçº§é™ä½

**åœºæ™¯1ï¼šç”¨æˆ·è‡ªå®šä¹‰è¯ç»„**

```
è¾“å…¥: "wo"
ä¸Šä¸‹æ–‡: "ä½ "

å€™é€‰:
- æˆ‘ (user_phrase, weight=-5.0)  â† ç”¨æˆ·ç»å¸¸ä½¿ç”¨
- çª (phrase, weight=-8.0)
```

**ä¿®æ”¹å‰**ï¼š
```
ç»„1 (user_phrase): [æˆ‘ (-5.0)]
ç»„2 (phrase): [çª (-8.0)]
æœ€ç»ˆ: [æˆ‘, çª]  â† ç”¨æˆ·è¯ç»„ä¼˜å…ˆ âœ…
```

**ä¿®æ”¹å**ï¼š
```
ç»„1 (end=2): [æˆ‘ (-5.0), çª (-8.0)]
æ’åºå: [æˆ‘, çª]  â† ç»“æœç›¸åŒ âœ…
```

**ç»“è®º**ï¼šå¦‚æœç”¨æˆ·è¯ç»„çš„æƒé‡æœ¬èº«å°±é«˜ï¼Œä¿®æ”¹åä»ç„¶æ’å‰é¢ã€‚**æ— å½±å“**ã€‚

---

**åœºæ™¯2ï¼šä¸Šä¸‹æ–‡è¯„åˆ†é€†è½¬**

```
è¾“å…¥: "wo"
ä¸Šä¸‹æ–‡: "èœ—ç‰›"

å€™é€‰:
- æˆ‘ (user_phrase, weight=-5.0, context=-12.0) â†’ æœ€ç»ˆ -17.0
- çª (phrase, weight=-8.0, context=-2.0) â†’ æœ€ç»ˆ -10.0
```

**ä¿®æ”¹å‰**ï¼š
```
ç»„1 (user_phrase): [æˆ‘ (-17.0)]
ç»„2 (phrase): [çª (-10.0)]
æœ€ç»ˆ: [æˆ‘, çª]  â† ç”¨æˆ·è¯ç»„ä¼˜å…ˆï¼ˆå³ä½¿è¯„åˆ†ä½ï¼‰âŒ
```

**ä¿®æ”¹å**ï¼š
```
ç»„1 (end=2): [çª (-10.0), æˆ‘ (-17.0)]
æœ€ç»ˆ: [çª, æˆ‘]  â† æŒ‰è¯„åˆ†æ’åº âœ…
```

**ç»“è®º**ï¼šè¿™æ˜¯**æœŸæœ›çš„è¡Œä¸º**ï¼ä¸Šä¸‹æ–‡è¯„åˆ†åº”è¯¥ä¸»å¯¼æ’åºã€‚

---

##### 2.2 æ€§èƒ½å½±å“

**ä¿®æ”¹å‰**ï¼š
- åˆ†ç»„æ•°é‡ï¼šå¤šä¸ªï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰
- æ¯ç»„å¤§å°ï¼šè¾ƒå°
- æ’åºæ¬¡æ•°ï¼šå¤šæ¬¡ï¼ˆæ¯ç»„ä¸€æ¬¡ï¼‰
- æ’åºå¤æ‚åº¦ï¼šO(nâ‚ log nâ‚) + O(nâ‚‚ log nâ‚‚) + ...

**ä¿®æ”¹å**ï¼š
- åˆ†ç»„æ•°é‡ï¼š1ä¸ªï¼ˆåªæŒ‰ä½ç½®åˆ†ç»„ï¼‰
- æ¯ç»„å¤§å°ï¼šè¾ƒå¤§ï¼ˆæœ€å¤š32ä¸ªï¼‰
- æ’åºæ¬¡æ•°ï¼š1æ¬¡
- æ’åºå¤æ‚åº¦ï¼šO(n log n)ï¼Œå…¶ä¸­ n â‰¤ 32

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
ä¿®æ”¹å‰: O(5 log 5) + O(10 log 10) + O(8 log 8) + ... â‰ˆ O(n log n)
ä¿®æ”¹å: O(32 log 32) â‰ˆ O(n log n)

ç»“è®º: æ€§èƒ½åŸºæœ¬ç›¸åŒï¼ˆéƒ½æ˜¯ O(n log n)ï¼‰
```

**å®é™…å½±å“**ï¼š**å‡ ä¹æ— å½±å“**ï¼ˆn å¾ˆå°ï¼Œéƒ½æ˜¯ 32 ä»¥å†…ï¼‰

---

##### 2.3 å¤šéŸ³èŠ‚å€™é€‰çš„å½±å“

**åœºæ™¯**ï¼šä¸åŒç»“æŸä½ç½®çš„å€™é€‰

```
è¾“å…¥: "nihao"
å€™é€‰:
- ä½  (phrase, end=2, weight=-5.0)
- ä½ å¥½ (phrase, end=5, weight=-3.0)
```

**ä¿®æ”¹å‰å’Œä¿®æ”¹å**ï¼š
```
ç»„1 (end=2): [ä½  (-5.0)]
ç»„2 (end=5): [ä½ å¥½ (-3.0)]
æœ€ç»ˆ: [ä½ , ä½ å¥½]
```

**ç»“è®º**ï¼šä¸åŒç»“æŸä½ç½®çš„å€™é€‰ä»ç„¶åˆ†ç»„ã€‚**æ— å½±å“**ã€‚

---

#### 3. è¾¹ç•Œæƒ…å†µåˆ†æ

##### 3.1 completion ç±»å‹

**åœºæ™¯**ï¼šè¡¥å…¨å€™é€‰

```
è¾“å…¥: "ni"
å€™é€‰:
- ä½  (phrase, end=2, weight=-5.0)
- ä½ å¥½ (completion, end=2, weight=-8.0)
```

**ä¿®æ”¹å‰**ï¼š
```
ç»„1 (phrase): [ä½  (-5.0)]
ç»„2 (completion): [ä½ å¥½ (-8.0)]
æœ€ç»ˆ: [ä½ , ä½ å¥½]  â† phrase ä¼˜å…ˆ
```

**ä¿®æ”¹å**ï¼š
```
ç»„1 (end=2): [ä½  (-5.0), ä½ å¥½ (-8.0)]
æœ€ç»ˆ: [ä½ , ä½ å¥½]  â† æŒ‰æƒé‡æ’åºï¼Œç»“æœç›¸åŒ
```

**ç»“è®º**ï¼šå¦‚æœ phrase æƒé‡æœ¬èº«å°±é«˜ï¼Œç»“æœä¸å˜ã€‚**æ— å½±å“**ã€‚

---

##### 3.2 æ··åˆç±»å‹

**åœºæ™¯**ï¼šå¤šç§ç±»å‹æ··åˆ

```
å€™é€‰åºåˆ—:
1. å¬ (user_phrase, end=1, weight=-24.75)
2. ä»– (phrase, end=1, weight=-23.64)
3. åº­ (phrase, end=1, weight=-6.48)
4. åœ (user_table, end=1, weight=-20.0)
5. å… (table, end=1, weight=-18.0)
```

**ä¿®æ”¹å‰**ï¼š
```
ç»„1 (user_phrase): [å¬ (-24.75)]
ç»„2 (phrase): [åº­ (-6.48), ä»– (-23.64)]
ç»„3 (user_table): [åœ (-20.0)]
ç»„4 (table): [å… (-18.0)]

æœ€ç»ˆ: [å¬, åº­, ä»–, åœ, å…]
```

**ä¿®æ”¹å**ï¼š
```
ç»„1 (end=1): [åº­ (-6.48), å… (-18.0), åœ (-20.0), ä»– (-23.64), å¬ (-24.75)]

æœ€ç»ˆ: [åº­, å…, åœ, ä»–, å¬]  â† å®Œå…¨æŒ‰æƒé‡æ’åº
```

**ç»“è®º**ï¼šçœŸæ­£çš„æƒé‡æ’åºï¼Œæ›´ç¬¦åˆä¸Šä¸‹æ–‡è¯„åˆ†çš„ç›®çš„ã€‚âœ…

---

### 4. å…¶ä»–ç»„ä»¶çš„å½±å“

#### 4.1 Filter å±‚

**ContextualTranslation çš„è¾“å‡º** â†’ **Filter å±‚å¤„ç†**

ä¿®æ”¹åï¼ŒFilter æ”¶åˆ°çš„å€™é€‰é¡ºåºæ”¹å˜ï¼š
- ä¿®æ”¹å‰ï¼šæŒ‰ç±»å‹åˆ†ç»„çš„é¡ºåº
- ä¿®æ”¹åï¼šæŒ‰æƒé‡æ’åºçš„é¡ºåº

**å½±å“**ï¼š
- å¦‚æœ Filter ä¾èµ–å€™é€‰é¡ºåº â†’ å¯èƒ½æœ‰å½±å“
- å¦‚æœ Filter ç‹¬ç«‹è¯„åˆ† â†’ æ— å½±å“

**å¸¸è§ Filter**ï¼š
- `uniquifier`ï¼šå»é‡ï¼Œä¸ä¾èµ–é¡ºåº âœ…
- `charset_filter`ï¼šå­—ç¬¦é›†è¿‡æ»¤ï¼Œä¸ä¾èµ–é¡ºåº âœ…
- `simplifier`ï¼šç®€ç¹è½¬æ¢ï¼Œä¸ä¾èµ–é¡ºåº âœ…
- `reverse_lookup_filter`ï¼šåæŸ¥ï¼Œä¸ä¾èµ–é¡ºåº âœ…

**ç»“è®º**ï¼šå¯¹å¸¸è§ Filter **æ— å½±å“**ã€‚

---

#### 4.2 Translator å±‚

**Translator** â†’ **ContextualTranslation** â†’ **è¾“å‡º**

ä¿®æ”¹åªå½±å“ ContextualTranslation å†…éƒ¨é€»è¾‘ï¼Œä¸å½±å“ Translatorã€‚

**ç»“è®º**ï¼š**æ— å½±å“**ã€‚

---

#### 4.3 ç”¨æˆ·å­¦ä¹ 

**ç”¨æˆ·è¯å…¸å­¦ä¹ **åŸºäºç”¨æˆ·é€‰æ‹©çš„å€™é€‰ï¼š

```cpp
// table_translator.cc L311-319
bool TableTranslator::Memorize(const CommitEntry& commit_entry) {
  for (const DictEntry* e : commit_entry.elements) {
    if (is_constructed(e)) {
      user_dict_->UpdateEntry(blessed, 1);  // æ›´æ–°è¯é¢‘
    }
  }
}
```

**å½±å“**ï¼š
- ä¿®æ”¹å‰ï¼šç”¨æˆ·å¯èƒ½æ›´å¤šé€‰æ‹© user_phraseï¼ˆå› ä¸ºæ’å‰é¢ï¼‰
- ä¿®æ”¹åï¼šç”¨æˆ·å¯èƒ½æ›´å¤šé€‰æ‹©ä¸Šä¸‹æ–‡æœ€ä¼˜çš„å€™é€‰

**ç»“è®º**ï¼š
- çŸ­æœŸï¼šç”¨æˆ·å¯èƒ½éœ€è¦é€‚åº”æ–°çš„æ’åº
- é•¿æœŸï¼šç”¨æˆ·è¯å…¸ä¼šå­¦ä¹ åˆ°æ›´ç¬¦åˆä¸Šä¸‹æ–‡çš„è¯ç»„ âœ…

---

## ğŸ“Š å½±å“æ€»ç»“

### æ­£é¢å½±å“ âœ…

| å½±å“ | ç¨‹åº¦ | è¯´æ˜ |
|------|------|------|
| **çœŸæ­£çš„æƒé‡æ’åº** | â­â­â­â­â­ | å€™é€‰å®Œå…¨æŒ‰ä¸Šä¸‹æ–‡è¯„åˆ†æ’åº |
| **ç¬¦åˆç”¨æˆ·æœŸæœ›** | â­â­â­â­â­ | "å®¶åº­"è¿™æ ·çš„æ­é…ä¼šæ­£ç¡®æ’ç¬¬ä¸€ |
| **Octagram æ•ˆæœæœ€å¤§åŒ–** | â­â­â­â­â­ | ä¸Šä¸‹æ–‡è¯„åˆ†å®Œå…¨å‘æŒ¥ä½œç”¨ |
| **ç”¨æˆ·ä½“éªŒæå‡** | â­â­â­â­ | å‡å°‘ç¿»é¡µæ¬¡æ•° |

---

### æ½œåœ¨é£é™© âš ï¸

| é£é™© | ç¨‹åº¦ | è¯´æ˜ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **ç”¨æˆ·è¯ç»„ä¼˜å…ˆçº§é™ä½** | â­ | å¦‚æœä¸Šä¸‹æ–‡è¯„åˆ†ä½ï¼Œå¯èƒ½æ’åé¢ | ç”¨æˆ·è¯ç»„é€šå¸¸æƒé‡é«˜ï¼Œå®é™…å½±å“å° |
| **æ€§èƒ½å½±å“** | â­ | å•æ¬¡æ’åºçš„æ•°æ®é‡å¢å¤§ | n â‰¤ 32ï¼Œå½±å“å¯å¿½ç•¥ |
| **ç”¨æˆ·é€‚åº”æœŸ** | â­â­ | ç”¨æˆ·éœ€è¦é€‚åº”æ–°çš„æ’åº | é•¿æœŸæ¥çœ‹ï¼Œä½“éªŒæ›´å¥½ |

---

### å…¼å®¹æ€§å½±å“

| ç»„ä»¶ | å½±å“ | è¯´æ˜ |
|------|------|------|
| **Filter å±‚** | âœ… æ— å½±å“ | å¸¸è§ Filter ä¸ä¾èµ–å€™é€‰é¡ºåº |
| **Translator å±‚** | âœ… æ— å½±å“ | åªä¿®æ”¹ ContextualTranslation å†…éƒ¨ |
| **ç”¨æˆ·è¯å…¸** | âš ï¸ è½»å¾®å½±å“ | é•¿æœŸä¼šå­¦ä¹ åˆ°æ›´ç¬¦åˆä¸Šä¸‹æ–‡çš„è¯ç»„ |
| **é…ç½®æ–‡ä»¶** | âœ… æ— å½±å“ | ä¸éœ€è¦ä¿®æ”¹é…ç½® |

---

## ğŸ¯ æ¨èå†³ç­–

### å»ºè®®ï¼š**é‡‡ç”¨æ–¹æ¡ˆ2ï¼ˆå–æ¶ˆç±»å‹åˆ†ç»„ï¼‰**

#### ç†ç”±

1. **ç¬¦åˆ ContextualTranslation çš„è®¾è®¡åˆè¡·**
   - ç›®çš„ï¼šæ ¹æ®ä¸Šä¸‹æ–‡è°ƒæ•´å€™é€‰æ’åº
   - ç±»å‹åˆ†ç»„é™åˆ¶äº†è¿™ä¸ªç›®çš„çš„å®ç°

2. **é£é™©å¯æ§**
   - ä¸»è¦é£é™©ï¼šç”¨æˆ·è¯ç»„ä¼˜å…ˆçº§é™ä½
   - å®é™…å½±å“ï¼šç”¨æˆ·è¯ç»„é€šå¸¸æƒé‡é«˜ï¼Œå®é™…æ’åºä¸ä¼šå˜å·®
   - è¾¹ç•Œæƒ…å†µï¼šå·²åˆ†æï¼Œæ— ä¸¥é‡é—®é¢˜

3. **æ€§èƒ½å½±å“å¯å¿½ç•¥**
   - n â‰¤ 32ï¼Œæ’åºå¼€é”€æå°
   - ä»å¤šæ¬¡å°æ’åºå˜ä¸ºä¸€æ¬¡å¤§æ’åºï¼Œå¤æ‚åº¦ç›¸åŒ

4. **ç”¨æˆ·ä½“éªŒæå‡**
   - "å®¶åº­"è¿™æ ·çš„æ­é…ä¼šæ­£ç¡®æ’ç¬¬ä¸€
   - å‡å°‘ç¿»é¡µæ¬¡æ•°
   - æ›´æ™ºèƒ½çš„å€™é€‰æ’åº

---

### å®æ–½å»ºè®®

#### 1. ä»£ç ä¿®æ”¹

```cpp
// src/rime/gear/contextual_translation.cc L23-24

// ä¿®æ”¹å‰
if (end_pos != cand->end() || last_type != cand->type()) {

// ä¿®æ”¹å
if (end_pos != cand->end()) {
```

**æ³¨æ„**ï¼šä¿ç•™ `last_type` å˜é‡çš„æ›´æ–°ï¼ˆL26ï¼‰ï¼Œä»¥ä¾¿å°†æ¥å¯èƒ½çš„è°ƒè¯•éœ€è¦ã€‚

---

#### 2. æµ‹è¯•å»ºè®®

##### 2.1 åŸºç¡€æµ‹è¯•

```
æµ‹è¯•1ï¼šåŸºæœ¬ä¸Šä¸‹æ–‡æ’åº
è¾“å…¥: "jia" â†’ "å®¶"
è¾“å…¥: "ting"
æœŸæœ›: "åº­" æ’ç¬¬ä¸€

æµ‹è¯•2ï¼šç”¨æˆ·è¯ç»„
è¾“å…¥: "wo" (å‡è®¾"æˆ‘"æ˜¯ç”¨æˆ·è¯ç»„)
æœŸæœ›: "æˆ‘" ä»ç„¶æ’å‰é¢ï¼ˆå› ä¸ºæƒé‡é«˜ï¼‰

æµ‹è¯•3ï¼šå¤šéŸ³èŠ‚
è¾“å…¥: "nihao"
æœŸæœ›: "ä½ " å’Œ "ä½ å¥½" åˆ†åˆ«åœ¨ä¸åŒç»„
```

---

##### 2.2 è¾¹ç•Œæµ‹è¯•

```
æµ‹è¯•4ï¼šæ··åˆç±»å‹
è¾“å…¥: åŒ…å« phrase, user_phrase, table, user_table çš„åœºæ™¯
æœŸæœ›: å®Œå…¨æŒ‰æƒé‡æ’åº

æµ‹è¯•5ï¼šcompletion
è¾“å…¥: è¡¥å…¨åœºæ™¯
æœŸæœ›: æŒ‰æƒé‡æ’åºï¼Œä¸å—ç±»å‹å½±å“

æµ‹è¯•6ï¼šæ— ä¸Šä¸‹æ–‡
è¾“å…¥: ç¬¬ä¸€ä¸ªå­—
æœŸæœ›: æŒ‰åŸå§‹æƒé‡æ’åºï¼ˆæ— ä¸Šä¸‹æ–‡è¯„åˆ†ï¼‰
```

---

##### 2.3 æ€§èƒ½æµ‹è¯•

```
æµ‹è¯•7ï¼šå¤§é‡å€™é€‰
è¾“å…¥: ç”Ÿæˆ 32 ä¸ªå€™é€‰çš„åœºæ™¯
æµ‹é‡: æ’åºè€—æ—¶
æœŸæœ›: < 1ms

æµ‹è¯•8ï¼šè¿ç»­è¾“å…¥
è¾“å…¥: è¿ç»­è¾“å…¥å¤šä¸ªå­—
æµ‹é‡: æ•´ä½“å“åº”æ—¶é—´
æœŸæœ›: æ— æ˜æ˜¾å»¶è¿Ÿ
```

---

#### 3. å›æ»šæ–¹æ¡ˆ

å¦‚æœå‘ç°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```cpp
// å›æ»šåˆ°åŸå§‹ç‰ˆæœ¬
if (end_pos != cand->end() || last_type != cand->type()) {
```

æˆ–è€…æ·»åŠ é…ç½®é€‰é¡¹ï¼š

```cpp
// å¯é…ç½®çš„åˆ†ç»„ç­–ç•¥
bool group_by_type = config->GetBool("contextual_translation/group_by_type");

if (end_pos != cand->end() || (group_by_type && last_type != cand->type())) {
```

---

#### 4. æ–‡æ¡£æ›´æ–°

æ›´æ–° CHANGELOGï¼š

```markdown
## [ç‰ˆæœ¬å·] - æ—¥æœŸ

### Changed
- ContextualTranslation: å–æ¶ˆç±»å‹åˆ†ç»„ï¼Œå®Œå…¨æŒ‰ä¸Šä¸‹æ–‡è¯„åˆ†æ’åº
  - å€™é€‰ç°åœ¨å®Œå…¨æŒ‰æƒé‡æ’åºï¼Œä¸å—ç±»å‹é™åˆ¶
  - æå‡äº†ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å‡†ç¡®æ€§
  - ä¾‹å¦‚ï¼š"å®¶åº­"çš„"åº­"ä¼šæ­£ç¡®æ’åœ¨ç¬¬ä¸€ä½
```

---

## ğŸ”¬ æ·±å±‚è®¾è®¡æ€è€ƒ

### ä¸ºä»€ä¹ˆåŸå§‹è®¾è®¡è¦æŒ‰ç±»å‹åˆ†ç»„ï¼Ÿ

#### å¯èƒ½çš„åŸå› 

1. **ä¿å®ˆç­–ç•¥**
   - é¿å… Octagram è¯„åˆ†è¿‡åº¦å½±å“æ’åº
   - ä¿ç•™ç”¨æˆ·è¯ç»„çš„ä¼˜å…ˆçº§
   - å‡å°‘ç”¨æˆ·é€‚åº”æˆæœ¬

2. **æ€§èƒ½è€ƒè™‘**
   - å¤šæ¬¡å°æ’åºå¯èƒ½æ¯”ä¸€æ¬¡å¤§æ’åºå¿«ï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ï¼‰
   - ä½†åœ¨ n â‰¤ 32 çš„æƒ…å†µä¸‹ï¼Œå·®å¼‚å¯å¿½ç•¥

3. **å†å²é—ç•™**
   - å¯èƒ½æ˜¯æ—©æœŸè®¾è®¡ï¼Œåæ¥æ²¡æœ‰ä¼˜åŒ–
   - æˆ–è€…æ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬

---

### æ›´å¥½çš„è®¾è®¡æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šå¯é…ç½®çš„åˆ†ç»„ç­–ç•¥

```yaml
# schema.yaml
contextual_translation:
  group_by_type: false  # æ˜¯å¦æŒ‰ç±»å‹åˆ†ç»„
  type_priority:        # ç±»å‹ä¼˜å…ˆçº§æƒé‡
    user_phrase: 1.0
    phrase: 0.8
    user_table: 0.6
    table: 0.4
```

**ä¼˜ç‚¹**ï¼š
- çµæ´»æ€§é«˜
- å¯ä»¥æ ¹æ®åœºæ™¯è°ƒæ•´

**ç¼ºç‚¹**ï¼š
- é…ç½®å¤æ‚
- ç”¨æˆ·éš¾ä»¥ç†è§£

---

#### æ–¹æ¡ˆBï¼šæ™ºèƒ½åˆ†ç»„ï¼ˆæ¨èï¼‰

```cpp
// æ ¹æ®æƒé‡å·®è·å†³å®šæ˜¯å¦åˆ†ç»„
if (end_pos != cand->end() || 
    (last_type != cand->type() && 
     abs(last_weight - cand->weight()) > threshold)) {
  AppendToCache(queue);
}
```

**é€»è¾‘**ï¼š
- å¦‚æœç±»å‹ä¸åŒï¼Œä½†æƒé‡å·®è·å° â†’ ä¸åˆ†ç»„
- å¦‚æœç±»å‹ä¸åŒï¼Œä¸”æƒé‡å·®è·å¤§ â†’ åˆ†ç»„

**ä¼˜ç‚¹**ï¼š
- å…¼é¡¾ç±»å‹ä¼˜å…ˆçº§å’Œæƒé‡æ’åº
- æ›´æ™ºèƒ½

**ç¼ºç‚¹**ï¼š
- éœ€è¦è°ƒæ•´ threshold
- é€»è¾‘å¤æ‚

---

#### æ–¹æ¡ˆCï¼šå®Œå…¨å–æ¶ˆåˆ†ç»„ï¼ˆæœ€ç®€å•ï¼‰

```cpp
if (end_pos != cand->end()) {
  AppendToCache(queue);
}
```

**ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´æ¥
- å®Œå…¨æŒ‰æƒé‡æ’åº
- ç¬¦åˆ Octagram çš„è®¾è®¡ç›®çš„

**ç¼ºç‚¹**ï¼š
- å¯èƒ½é™ä½ç”¨æˆ·è¯ç»„ä¼˜å…ˆçº§ï¼ˆå®é™…å½±å“å°ï¼‰

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### é‡‡ç”¨æ–¹æ¡ˆCï¼šå®Œå…¨å–æ¶ˆç±»å‹åˆ†ç»„

**ç†ç”±**ï¼š
1. âœ… ç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
2. âœ… å®Œå…¨å‘æŒ¥ Octagram çš„ä½œç”¨
3. âœ… é£é™©å¯æ§ï¼Œå®é™…å½±å“å°
4. âœ… æ€§èƒ½å½±å“å¯å¿½ç•¥
5. âœ… ç¬¦åˆç”¨æˆ·æœŸæœ›ï¼ˆ"å®¶åº­"æ’ç¬¬ä¸€ï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. ä¿®æ”¹ä»£ç ï¼ˆä¸€è¡Œï¼‰
2. ç¼–è¯‘æµ‹è¯•
3. éªŒè¯åŸºç¡€åœºæ™¯
4. éªŒè¯è¾¹ç•Œåœºæ™¯
5. æ€§èƒ½æµ‹è¯•
6. å‘å¸ƒæ›´æ–°

**é¢„æœŸæ•ˆæœ**ï¼š
- ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ›´å‡†ç¡®
- ç”¨æˆ·ä½“éªŒæå‡
- å‡å°‘ç¿»é¡µæ¬¡æ•°
- æ›´æ™ºèƒ½çš„å€™é€‰æ’åº

---

## ğŸ“ æ€»ç»“

### ContextualTranslation çš„æ ¸å¿ƒé€»è¾‘

1. **åˆ†ç»„**ï¼šæŒ‰ç»“æŸä½ç½®ï¼ˆå’Œç±»å‹ï¼‰åˆ†ç»„
2. **è¯„åˆ†**ï¼šä½¿ç”¨ Octagram è®¡ç®—ä¸Šä¸‹æ–‡è¯„åˆ†
3. **æ’åº**ï¼šç»„å†…æŒ‰æƒé‡é™åºæ’åº
4. **è¾“å‡º**ï¼šæŒ‰ç»„é¡ºåºè¾“å‡ºå€™é€‰

### ä¿®æ”¹å½±å“

- âœ… **æ­£é¢å½±å“å¤§**ï¼šçœŸæ­£çš„æƒé‡æ’åºï¼Œç¬¦åˆç”¨æˆ·æœŸæœ›
- âš ï¸ **é£é™©å¯æ§**ï¼šä¸»è¦é£é™©æ˜¯ç”¨æˆ·è¯ç»„ä¼˜å…ˆçº§é™ä½ï¼Œä½†å®é™…å½±å“å°
- âœ… **æ€§èƒ½æ— å½±å“**ï¼šn â‰¤ 32ï¼Œæ’åºå¼€é”€å¯å¿½ç•¥
- âœ… **å…¼å®¹æ€§å¥½**ï¼šå¯¹å…¶ä»–ç»„ä»¶æ— å½±å“

### æ¨èå†³ç­–

**é‡‡ç”¨æ–¹æ¡ˆ2ï¼šå–æ¶ˆç±»å‹åˆ†ç»„**

è¿™æ˜¯ä¸€ä¸ª**ä½é£é™©ã€é«˜æ”¶ç›Š**çš„ä¼˜åŒ–ï¼Œå¼ºçƒˆæ¨èå®æ–½ã€‚
