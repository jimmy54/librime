# 阶段一：基于手机 WebDAV 的离线多设备同步设计

## 1. 背景与目标
- 现状：手机已经提供 WebDAV 服务（例如 FolderSync、内置文件管理器），是目前唯一稳定上线的节点。
- 阶段目标：在不依赖云端的前提下，让手机、平板、PC 等设备在离线或弱网环境下完成文件同步与备份。
- 愿景：像把重要书籍放在随身携带的“移动书箱”中，其他设备在需要时靠近书箱就能取书、放书，离开后也能保留副本。

## 2. 设计原则
1. **离线优先**：所有同步流程在局域网甚至点对点热点环境下完成，不依赖公网服务。
2. **轻量部署**：尽量使用可执行文件或便携式包，避免复杂服务器。
3. **渐进扩展**：为后续扩展到云或集群预留接口，但当前阶段不强制引入。
4. **安全可控**：数据传输加密、设备互认，确保私有资料不外泄。
5. **易维护**：操作步骤简单，适合非专业人员日常使用。

## 3. 角色与组件
```
┌──────────────────────────────────┐
│             设备角色             │
├─────────────┬────────────────────┤
│ 手机（主仓） │ WebDAV 服务 + Syncthing │
├─────────────┼────────────────────┤
│ 家庭 PC      │ Syncthing + rclone CLI │
├─────────────┼────────────────────┤
│ 平板/笔记本  │ Syncthing (可选：FolderSync) │
├─────────────┼────────────────────┤
│ 便携硬盘备用 │ restic/rsync 快照备份      │
└─────────────┴────────────────────┘
```

### 3.1 手机 WebDAV 主仓
- 作为“总目录”，保存最新权威文件。建议开启以下配置：
  - WebDAV 根目录专用文件夹，例如 `/storage/emulated/0/WebDAVRoot`。
  - 支持 HTTPS（可使用自签证书或通过 Caddy/Traefik 在手机上反向代理）。
  - 开启应用内版本历史或 Trash 机制，以防误删除。

### 3.2 多端同步代理（Syncthing）
- Syncthing 提供 P2P 同步与文件改动监听（观察者模式）能力：
  - 手机运行 Syncthing Android，监控 WebDAV 根目录。
  - 电脑端使用 Syncthing Desktop，设置 **双向同步文件夹**，支持断点续传。
  - 如果某设备暂时无法安装 Syncthing，可使用 rclone + 定时任务作为过渡方案。
- 传输走局域网热点，若无网络可由手机临时开热点，让终端加入后同步。

### 3.3 增强工具
- **rclone**：在需要“手动搬运”时，通过 `rclone sync webdav:/root local:/backup` 保证与 WebDAV 一致。
- **restic**：在家用 PC 上定期对同步目录做快照，便于恢复历史版本。
- **KeePass/Bitwarden（可选）**：管理各设备的访问密钥与自签证书。

## 4. 核心流程
### 4.1 首次建立同步
1. 手机端：确认 WebDAV 地址、账号密码，创建用于同步的共享文件夹（例如 `sync/`）。
2. 手机安装 Syncthing：选择 `sync/` 作为共享目录，生成设备 ID。
3. 电脑/平板安装 Syncthing：导入手机设备 ID，并共享本地同步目录，设置为 **双向同步**。
4. 双方验证指纹后批准互信，开始初次同步（可选择局域网 Wi-Fi 或手机热点）。

### 4.2 日常离线同步
场景示例：外出携带手机和笔记本，旅店 Wi-Fi 不可靠。
1. 手机开启热点并启动 WebDAV 与 Syncthing。
2. 笔记本连接热点，Syncthing 自动发现手机，同步增量文件。
3. 若某些批量文件需要立即上传，可手动执行 `rclone sync local:/docs webdav:/sync/docs --bwlimit 2M`。

### 4.3 家庭中心节点（可选）
- 在家中 PC 或 NAS 上配置 Syncthing 与 restic：
  - Syncthing 与手机保持双向同步，承担“常在线缓存仓库”角色。
  - restic 定时将 PC 上的同步目录打包到外接硬盘或冷存储（每晚一次）。
  - 该 PC 不必 24 小时运行，但建议每周至少上线一次，集中完成备份。

### 4.4 便携硬盘补充方案
- 若遇到完全无网络场景，可借助便携硬盘实现“物理搬运”：
  1. 笔记本用 `rsync -av` 将新增文件复制到硬盘。
  2. 回到家后通过 PC 再次 `rsync` 入 PC 同步目录，Syncthing 自动分发给手机。
- 这个过程类似“接力赛”，确保即便完全离线也能在不借助云端的情况下汇总文件。

## 5. 冲突与版本控制
- Syncthing 自带版本管理（Trash Can/时间戳策略），建议开启并保留最近 30 个版本。
- 规则：
  1. **时间戳优先策略**：默认保留最近修改的版本。
  2. **类型感知策略**（策略模式）：
     - 文本类：可使用 VS Code 的 `File History` 插件或 `git` 进行人工对比。
     - 二进制类：Syncthing 自动生成 `sync~冲突-设备名-时间.ext`，用户手动甄别。
- 建议建立“修改日志”Excel 或 Markdown，关键文件改动时手动记录，便于回顾。

## 6. 安全设计
1. **加密传输**：Syncthing 默认 TLS 加密；WebDAV 建议启用 HTTPS。
2. **设备信任列表**：Syncthing 新设备加入需手动审批，防止陌生终端接入。
3. **访问凭证管理**：
   - WebDAV 账号密码保存在 KeePass；
   - 定期（每季度）轮换密码，旧密码立即失效。
4. **设备丢失应对**：
   - 手机丢失：立即在其他设备上暂停与该设备的 Syncthing 连接，变更 WebDAV 密码。
   - 电脑丢失：远程执行 `syncthing cli config folders default rescan` 触发所有文件校验，并清理凭证。

## 7. 部署与运维建议
| 步骤 | 目标 | 工具/命令 |
| --- | --- | --- |
| 第 1 天 | 在手机上确认 WebDAV、安装 Syncthing | 手机应用商店（Syncthing-Fork） |
| 第 2 天 | 在主力 PC 上配置 Syncthing + rclone | `syncthing.exe`, `scoop install rclone` |
| 第 3 天 | 验证热点同步与文件冲突处理 | 手动编辑同一文档，观察 Syncthing 冲突提示 |
| 第 4 天 | 配置 restic 快照备份 | `restic init`; `restic backup D:\Sync` |
| 第 7 天 | 演练离线场景 | 模拟无网环境，仅用手机热点完成一次双向同步 |

- **监控方式**：
  - Syncthing Web UI（本地 8384 端口）查看同步状态。
  - 在 PC 上编写简单脚本，每天检查是否有冲突文件并推送到手机提醒。
- **维护节奏**：
  - 每周检查一次 restic 日志；
  - 每月导出一次重要目录到外部硬盘做长期归档。

## 8. 风险与对策
- **手机空间不足**：使用 Syncthing 的“仅接收”模式，让大文件只留在 PC；手机需要时再临时拉取。
- **热点耗电**：同步时准备移动电源，或使用 USB 共享网络降低功耗。
- **文件误删除**：开启版本保留 + restic 快照，双重保障。
- **同步错误**：编写健康检查脚本，若 Syncthing 长时间未同步则提醒用户手动检查。

## 9. 后续扩展接口（面向下一阶段）
- 保留以下可升级点：
  1. WebDAV 目录结构与权限设计与未来引入 Nextcloud 完全兼容。
  2. Syncthing 可无缝加入更多节点（例如家庭 NAS）。
  3. restic 仓库可迁移至对象存储，实现异地备份。
  4. 若未来引入集中式服务，只需将现有同步目录挂接到新平台，不影响终端配置。

## 10. 设计模式说明
- **观察者模式**：Syncthing 监听文件变化，像仓库门口装了警铃，只要有人搬动箱子就通知其他仓库。
- **策略模式**：针对不同文件类型使用不同冲突处理策略，就像店长针对易碎品和日用品制定不同退换规则。
- **模板方法模式**（同步流程脚本）：统一规定“检测 → 同步 → 校验 → 备份”的四步流程，各设备脚本只需填充细节。

---
**阶段一结论**：通过“手机 WebDAV 主仓 + Syncthing P2P + restic 快照”的组合，可在纯离线环境下保证多设备文件同步与历史追溯。方案部署成本低、操作简单，并为后续扩展到云端高可用集群保留接口。
